<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julia Berlik Foto | Strefa Klienta</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body oncontextmenu="return false;">

    <div id="toast-container">
        <div id="toast-text">Komunikat</div>
    </div>

    <div id="lightbox">
        <div class="lb-close" onclick="app.closeLightbox()">&times;</div>
        <div class="lb-nav lb-prev" onclick="app.prevPhoto()">&#10094;</div>
        <div class="lb-nav lb-next" onclick="app.nextPhoto()">&#10095;</div>
        <img id="lightbox-img" src="" alt="Podgląd">
        <div class="lb-controls">
            <button id="lb-select-btn" class="lb-select-btn" onclick="app.toggleSelectionFromLightbox()">Wybierz zdjęcie</button>
        </div>
    </div>

    <div class="brand-title">
        Julia Berlik <span>Foto</span>
    </div>

    <div id="view-login" class="container hidden">
        <div class="card">
            <h2>Panel Fotografa</h2>
            <p style="color:#888; margin-bottom:20px;">Zaloguj się, aby zarządzać sesjami</p>
            <form onsubmit="event.preventDefault(); app.login()">
                <input type="email" id="email" placeholder="Email" required value="admin@example.com">
                <input type="password" id="password" placeholder="Hasło" required value="admin123">
                <button type="submit" style="width:100%">Wejdź</button>
            </form>
        </div>
    </div>

    <div id="view-dashboard" class="container hidden fade-in">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h3>Zarządzanie Sesjami</h3>
            <div>
                <button onclick="router.go('upload')">+ Nowa Sesja</button>
                <button onclick="app.logout()" style="background:#eee; color:#333; margin-left:10px;">Wyloguj</button>
            </div>
        </header>
        <div id="albums-list"></div>
    </div>

    <div id="view-upload" class="container hidden fade-in">
        <button onclick="router.go('dashboard')" style="background:transparent; color:#333; border:1px solid #ddd; margin-bottom:20px;">← Wróć</button>
        <div class="card" style="max-width:800px;">
            <h2>Utwórz Sesję</h2>
            <form onsubmit="event.preventDefault(); app.createAlbum()">
                <label>Nazwa Sesji</label>
                <input type="text" id="albumTitle" placeholder="np. Ślub Ani" required>
                <label>Klient</label>
                <input type="text" id="clientName" placeholder="Imię i Nazwisko" required>
                <label>Email (Opcjonalnie)</label>
                <input type="email" id="clientEmailUpload" placeholder="Jeśli podasz, wyślemy link">
                
                <div style="border:2px dashed #ddd; padding:30px; margin:20px 0;">
                    <p>Wybierz pliki JPG</p>
                    <input type="file" id="files" multiple accept="image/jpeg" required>
                </div>
                <button type="submit" id="uploadBtn" style="width:100%">Rozpocznij Upload</button>
            </form>
            <div id="upload-status" style="margin-top:20px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="view-gallery" class="hidden">
        <div class="container">
            <div class="gallery-container fade-in">
                <header class="gallery-header">
                    <div>
                        <h2 id="gallery-title" style="font-size:1.5rem; margin:0;">Tytuł</h2>
                        <p style="font-size:0.9rem; color:#888;">Kliknij serce na zdjęciu, aby je wybrać.</p>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:flex-end;">
                        <span id="selection-count" style="font-weight:bold; color:var(--accent); font-size:1.2rem;">0 wybranych</span>
                        <button id="saveBtn" onclick="app.saveSelection()">Zatwierdź Wybór</button>
                    </div>
                </header>

                <div class="filters">
                    <button class="filter-btn active" onclick="app.setFilter('all')">Wszystkie</button>
                    <button class="filter-btn" onclick="app.setFilter('selected')">Tylko Wybrane ❤</button>
                </div>
                
                <div id="grid" class="gallery-grid"></div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';

        const router = {
            views: ['login', 'dashboard', 'upload', 'gallery'],
            go(viewId) {
                // Ukryj wszystkie
                this.views.forEach(v => {
                    const el = document.getElementById('view-' + v);
                    if(el) el.classList.add('hidden');
                });
                // Pokaż wybrany
                const active = document.getElementById('view-' + viewId);
                if(active) active.classList.remove('hidden');
                
                // Ukryj branding w widoku galerii (opcjonalne, dla czystości)
                if(viewId === 'gallery') document.querySelector('.brand-title').style.display = 'block';
            }
        };

        const app = {
            state: { jwt: localStorage.getItem('photo_jwt'), selected: new Set(), currentAlbumToken: null, photos: [], currentPhotoIndex: 0, viewFilter: 'all' },

            init() {
                // Obsługa klawiszy
                document.addEventListener('keydown', (e) => {
                    if (!document.getElementById('lightbox').classList.contains('active')) return;
                    if (e.key === 'ArrowLeft') this.prevPhoto();
                    if (e.key === 'ArrowRight') this.nextPhoto();
                    if (e.key === 'Escape') this.closeLightbox();
                    if (e.key === ' ') { e.preventDefault(); this.toggleSelectionFromLightbox(); }
                });

                // ROUTING - To naprawia błąd widoczności logowania dla klienta
                const path = window.location.pathname;
                if (path.startsWith('/gallery/')) {
                    const token = path.split('/')[2];
                    if(token) {
                        this.loadGallery(token);
                    }
                } else {
                    if (this.state.jwt) this.loadDashboard(); else router.go('login');
                }
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast-container');
                const text = document.getElementById('toast-text');
                text.innerText = message;
                toast.classList.add('active');
                setTimeout(() => { toast.classList.remove('active'); }, 3500);
            },

            async login() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    const res = await fetch(API + '/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    this.state.jwt = data.token;
                    localStorage.setItem('photo_jwt', data.token);
                    this.loadDashboard();
                } catch (err) { alert(err.message); }
            },

            logout() { localStorage.removeItem('photo_jwt'); this.state.jwt = null; router.go('login'); },

            async loadDashboard() {
                router.go('dashboard');
                try {
                    const res = await fetch(API + '/admin/albums', { headers: { 'Authorization': 'Bearer ' + this.state.jwt } });
                    const albums = await res.json();
                    const container = document.getElementById('albums-list');
                    
                    if(albums.length === 0) {
                        container.innerHTML = '<p style="text-align:center; color:#888;">Brak albumów.</p>';
                        return;
                    }

                    container.innerHTML = albums.map(a => {
                        return `
                        <div style="background:white; padding:20px; margin-bottom:15px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                            <div>
                                <h3 style="margin-bottom:5px;">${a.title}</h3>
                                <p style="color:#666; font-size:0.9rem;">${a.client_name} • ${a.photo_count || 0} zdjęć • Wybrano: <strong>${a.selection_count || 0}</strong></p>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button onclick="app.copyFilenames('${a.id}')" class="btn-copy" style="font-size:11px;">Kopiuj listę</button>
                                <a href="/gallery/${a.access_token}" target="_blank"><button style="font-size:11px;">Podgląd</button></a>
                                <button onclick="app.deleteAlbum('${a.id}')" class="btn-danger" style="font-size:11px;">Usuń</button>
                            </div>
                        </div>
                    `}).join('');
                } catch (err) { console.error(err); }
            },

            async copyFilenames(albumId) {
                try {
                    const res = await fetch(API + '/admin/albums/' + albumId + '/files', { 
                        headers: { 'Authorization': 'Bearer ' + this.state.jwt } 
                    });
                    const data = await res.json();
                    
                    if(data.filenames && data.filenames.length > 0) {
                        const textToCopy = data.filenames.join(', ');
                        navigator.clipboard.writeText(textToCopy);
                        this.showToast('Skopiowano listę plików!', 'success');
                    } else {
                        this.showToast('Brak wybranych zdjęć.', 'error');
                    }
                } catch (err) { this.showToast('Błąd kopiowania.', 'error'); }
            },

            async deleteAlbum(id) {
                if(!confirm('Czy na pewno chcesz usunąć ten album?')) return;
                try {
                    const res = await fetch(API + '/albums/' + id, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + this.state.jwt }
                    });
                    if(res.ok) {
                        this.showToast('Album usunięty.', 'success');
                        this.loadDashboard();
                    } else { throw new Error('Błąd usuwania'); }
                } catch (err) { this.showToast('Błąd: ' + err.message, 'error'); }
            },

            async createAlbum() {
                const btn = document.getElementById('uploadBtn');
                const statusDiv = document.getElementById('upload-status');
                btn.disabled = true; btn.innerText = "Przetwarzanie...";
                try {
                    const title = document.getElementById('albumTitle').value;
                    const clientName = document.getElementById('clientName').value;
                    const clientEmail = document.getElementById('clientEmailUpload').value;
                    const res1 = await fetch(API + '/albums', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + this.state.jwt }, body: JSON.stringify({ title, clientName }) });
                    const albumData = await res1.json();
                    const albumId = albumData[0].id;
                    const accessToken = albumData[0].access_token;
                    const files = document.getElementById('files').files;
                    const formData = new FormData();
                    formData.append('albumId', albumId);
                    
                    // Upload
                    for (let i = 0; i < files.length; i++) formData.append('photos', files[i]);
                    statusDiv.innerText = "Wysyłanie zdjęć... Proszę czekać.";
                    const res2 = await fetch(API + '/upload', { method: 'POST', headers: { 'Authorization': 'Bearer ' + this.state.jwt }, body: formData });
                    
                    if(res2.ok) { 
                        if (clientEmail) {
                            statusDiv.innerText = "Wysyłanie maila...";
                            const link = window.location.origin + '/gallery/' + accessToken;
                            await fetch(API + '/send-link', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + this.state.jwt }, body: JSON.stringify({ clientEmail: clientEmail, albumTitle: title, link: link }) });
                            this.showToast('Wysłano do klienta!', 'success');
                        } else { this.showToast('Gotowe!', 'success'); }
                        this.loadDashboard(); 
                    } else throw new Error('Błąd uploadu');
                } catch (err) { this.showToast(err.message, 'error'); } finally { btn.disabled = false; btn.innerText = "Rozpocznij Upload"; statusDiv.innerText = ""; }
            },

            async loadGallery(token) {
                this.state.currentAlbumToken = token;
                router.go('gallery');
                
                const grid = document.getElementById('grid');
                // Skeletony
                grid.innerHTML = Array(8).fill('<div class="photo-card skeleton"></div>').join('');

                try {
                    const res = await fetch(API + '/gallery/' + token);
                    if(!res.ok) throw new Error('Błąd');
                    const data = await res.json();
                    
                    document.getElementById('gallery-title').innerText = data.album[0].title;
                    
                    this.state.selected = new Set(data.selections);
                    this.state.photos = data.photos;
                    this.renderGrid();
                    this.updateCounter();

                    if(!localStorage.getItem('visited_' + token)) {
                        this.showToast('Witaj! Wybierz zdjęcia klikając serce.', 'success');
                        localStorage.setItem('visited_' + token, 'true');
                    }
                } catch (err) { 
                    // Jeśli błąd, ukryj wszystko i pokaż komunikat
                    document.getElementById('view-gallery').innerHTML = "<div class='container' style='text-align:center; padding:100px;'><h1>404</h1><p>Nie znaleziono galerii.</p></div>"; 
                }
            },

            setFilter(type) {
                this.state.viewFilter = type;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                this.renderGrid();
            },

            renderGrid() {
                const grid = document.getElementById('grid');
                let photosToShow = this.state.photos;

                if (this.state.viewFilter === 'selected') {
                    photosToShow = this.state.photos.filter(p => this.state.selected.has(p.id));
                }

                if (photosToShow.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; padding:40px; color:#888;">Brak zdjęć do wyświetlenia.</p>';
                    return;
                }

                grid.innerHTML = photosToShow.map((p) => {
                    const originalIndex = this.state.photos.findIndex(photo => photo.id === p.id);
                    const isSelected = this.state.selected.has(p.id) ? 'selected' : '';
                    
                    return `
                    <div class="photo-card ${isSelected}" onclick="app.openLightbox(${originalIndex})">
                        <div class="heart-icon" onclick="event.stopPropagation(); app.toggleSelection(${originalIndex})">
                            ${isSelected ? '❤' : '♡'}
                        </div>
                        <img src="${p.proof_url}" loading="lazy" alt="Zdjęcie">
                    </div>`;
                }).join('');
            },

            toggleSelection(index) {
                const p = this.state.photos[index];
                if (this.state.selected.has(p.id)) this.state.selected.delete(p.id);
                else {
                    this.state.selected.add(p.id);
                    if(navigator.vibrate) navigator.vibrate(50);
                }
                this.renderGrid(); 
                this.updateCounter();
            },

            openLightbox(index) {
                this.state.currentPhotoIndex = index;
                const p = this.state.photos[index];
                const box = document.getElementById('lightbox');
                document.getElementById('lightbox-img').src = p.proof_url;
                box.classList.add('active');
                this.updateLightboxUI();
            },
            closeLightbox() { document.getElementById('lightbox').classList.remove('active'); },
            
            nextPhoto() { 
                if (this.state.currentPhotoIndex < this.state.photos.length - 1) 
                    this.openLightbox(this.state.currentPhotoIndex + 1); 
            },
            prevPhoto() { 
                if (this.state.currentPhotoIndex > 0) 
                    this.openLightbox(this.state.currentPhotoIndex - 1); 
            },

            toggleSelectionFromLightbox() {
                const p = this.state.photos[this.state.currentPhotoIndex];
                if (this.state.selected.has(p.id)) this.state.selected.delete(p.id);
                else this.state.selected.add(p.id);
                this.updateLightboxUI();
                this.renderGrid();
                this.updateCounter();
            },

            updateLightboxUI() {
                const p = this.state.photos[this.state.currentPhotoIndex];
                const btn = document.getElementById('lb-select-btn');
                if (this.state.selected.has(p.id)) {
                    btn.classList.add('active');
                    btn.innerText = "❤ WYBRANE";
                } else {
                    btn.classList.remove('active');
                    btn.innerText = "Wybierz zdjęcie";
                }
            },

            updateCounter() { 
                document.getElementById('selection-count').innerText = `${this.state.selected.size} wybranych`; 
            },

            async saveSelection() {
                const btn = document.getElementById('saveBtn');
                btn.innerText = "Wysyłanie..."; btn.disabled = true;
                const token = this.state.currentAlbumToken;
                try {
                    await fetch(API + '/select', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ token: token, photoIds: Array.from(this.state.selected) }) 
                    });
                    this.showToast('Wybór zapisany i wysłany!', 'success');
                } catch (err) { 
                    this.showToast('Błąd zapisu.', 'error'); 
                } finally { 
                    btn.innerText = "Zatwierdź Wybór"; btn.disabled = false; 
                }
            }
        };

        app.init();
    </script>
</body>
</html>
