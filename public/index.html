<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strefa Klienta</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body oncontextmenu="return false;">

    <div id="toast-container">
        <div class="toast-icon">✓</div>
        <div id="toast-text">Komunikat</div>
    </div>

    <div id="lightbox">
        <div class="lb-close" onclick="app.closeLightbox()">&times;</div>
        <div class="lb-nav lb-prev" onclick="app.prevPhoto()">&#10094;</div>
        <div class="lb-nav lb-next" onclick="app.nextPhoto()">&#10095;</div>
        <img id="lightbox-img" src="" alt="Podgląd">
        <div class="lb-controls">
            <button id="lb-select-btn" class="lb-select-btn" onclick="app.toggleSelectionFromLightbox()">Wybierz zdjęcie</button>
        </div>
    </div>

    <div id="view-login" class="container hidden" style="height:100vh; display:flex; align-items:center; justify-content:center;">
        <div class="card" style="text-align:center;">
            <h1>Strefa Fotografa</h1>
            <p style="color:#888; margin-bottom:30px;">Zaloguj się do panelu</p>
            <form onsubmit="event.preventDefault(); app.login()">
                <input type="email" id="email" placeholder="Email" required value="admin@example.com">
                <input type="password" id="password" placeholder="Hasło" required value="admin123">
                <button type="submit" style="width:100%">Wejdź</button>
            </form>
        </div>
    </div>

    <div id="view-dashboard" class="container hidden fade-in">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px; border-bottom:1px solid #eee; padding-bottom:20px;">
            <div>
                <h1>Moje Sesje</h1>
                <p>Panel zarządzania</p>
            </div>
            <div>
                <button onclick="router.go('upload')">+ Nowa Sesja</button>
                <button onclick="app.logout()" style="background:#eee; color:#333; margin-left:10px;">Wyloguj</button>
            </div>
        </header>
        <div id="albums-list">
            </div>
    </div>

    <div id="view-upload" class="container hidden fade-in">
        <button onclick="router.go('dashboard')" style="background:transparent; color:#333; border:1px solid #ddd; margin-bottom:20px;">← Wróć</button>
        <div class="card" style="max-width:800px;">
            <h2 style="text-align:center;">Utwórz Sesję</h2>
            <form onsubmit="event.preventDefault(); app.createAlbum()">
                <label>Nazwa Sesji</label>
                <input type="text" id="albumTitle" placeholder="np. Ślub Ani i Tomka" required>
                
                <label>Klient</label>
                <input type="text" id="clientName" placeholder="Imię i Nazwisko" required>

                <label>Email Klienta (Opcjonalnie)</label>
                <input type="email" id="clientEmailUpload" placeholder="Jeśli wpiszesz, wyślemy link automatycznie">

                <div style="border:2px dashed #ddd; padding:40px; text-align:center; margin:20px 0;">
                    <p>Wybierz zdjęcia (JPG)</p>
                    <input type="file" id="files" multiple accept="image/jpeg" required>
                </div>
                <button type="submit" id="uploadBtn" style="width:100%">Rozpocznij Upload</button>
            </form>
            <div id="upload-status" style="margin-top:20px; text-align:center; font-weight:bold;"></div>
        </div>
    </div>

    <div id="view-gallery" class="hidden">
        <div class="hero">
            <div class="hero-content fade-in">
                <h1 id="gallery-hero-title">Galeria</h1>
                <p>Wybierz swoje ulubione ujęcia</p>
            </div>
        </div>

        <div class="container" style="margin-top:-60px;">
            <div class="gallery-container fade-in">
                <header class="gallery-header">
                    <div>
                        <h2 id="gallery-title" style="font-size:1.5rem;">Tytuł</h2>
                        <p style="font-size:0.9rem; color:#888;">Kliknij serce, aby wybrać zdjęcie.</p>
                    </div>
                    <div style="display:flex; align-items:center; gap:15px;">
                        <span id="selection-count" style="font-weight:bold; color:var(--accent);">0 wybranych</span>
                        <button id="saveBtn" onclick="app.saveSelection()">Zatwierdź Wybór</button>
                    </div>
                </header>
                
                <div id="grid" class="gallery-grid">
                    </div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';

        // Router - przełączanie widoków
        const router = {
            views: ['login', 'dashboard', 'upload', 'gallery'],
            go(viewId) {
                this.views.forEach(v => document.getElementById('view-' + v)?.classList.add('hidden'));
                document.getElementById('view-' + viewId)?.classList.remove('hidden');
                window.scrollTo(0,0);
            }
        };

        const app = {
            state: { jwt: localStorage.getItem('photo_jwt'), selected: new Set(), currentAlbumToken: null, photos: [], currentPhotoIndex: 0 },

            init() {
                // Obsługa klawiszy (strzałki)
                document.addEventListener('keydown', (e) => {
                    if (!document.getElementById('lightbox').classList.contains('active')) return;
                    if (e.key === 'ArrowLeft') this.prevPhoto();
                    if (e.key === 'ArrowRight') this.nextPhoto();
                    if (e.key === 'Escape') this.closeLightbox();
                    if (e.key === ' ') { e.preventDefault(); this.toggleSelectionFromLightbox(); }
                });

                // Sprawdzamy czy to link do galerii czy panelu
                const path = window.location.pathname;
                if (path.startsWith('/gallery/')) {
                    const token = path.split('/')[2];
                    this.loadGallery(token);
                } else {
                    if (this.state.jwt) this.loadDashboard(); else router.go('login');
                }
            },

            // Wyświetlanie powiadomień (Toast)
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast-container');
                const text = document.getElementById('toast-text');
                const icon = toast.querySelector('.toast-icon');
                
                text.innerText = message;
                icon.innerHTML = type === 'success' ? '✓' : '!';
                icon.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
                
                toast.classList.add('active');
                setTimeout(() => { toast.classList.remove('active'); }, 3500);
            },

            // Logowanie
            async login() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    const res = await fetch(API + '/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    this.state.jwt = data.token;
                    localStorage.setItem('photo_jwt', data.token);
                    this.loadDashboard();
                } catch (err) { alert(err.message); }
            },

            logout() { localStorage.removeItem('photo_jwt'); this.state.jwt = null; router.go('login'); },

            // Ładowanie listy albumów (Dashboard)
            async loadDashboard() {
                router.go('dashboard');
                try {
                    const res = await fetch(API + '/admin/albums', { headers: { 'Authorization': 'Bearer ' + this.state.jwt } });
                    const albums = await res.json();
                    const container = document.getElementById('albums-list');
                    
                    if(albums.length === 0) {
                        container.innerHTML = '<div style="text-align:center; padding:40px; color:#888;"><p>Brak albumów.</p></div>';
                        return;
                    }

                    container.innerHTML = albums.map(a => {
                        return `
                        <div style="background:white; padding:20px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center;">
                            <div>
                                <h3 style="margin-bottom:5px;">${a.title}</h3>
                                <p style="color:#666; font-size:0.9rem;">${a.client_name} • ${a.photo_count || 0} zdjęć • Wybrano: <strong>${a.selection_count || 0}</strong></p>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <a href="/gallery/${a.access_token}" target="_blank"><button style="padding:10px 20px; font-size:12px;">Podgląd</button></a>
                                <button onclick="app.deleteAlbum('${a.id}')" class="btn-danger" style="padding:10px 20px; font-size:12px;">Usuń</button>
                            </div>
                        </div>
                    `}).join('');
                } catch (err) { console.error(err); }
            },

            // USUWANIE ALBUMU
            async deleteAlbum(id) {
                if(!confirm('Czy na pewno chcesz usunąć ten album? Usuniesz też wszystkie zdjęcia i wybory klienta.')) return;
                try {
                    const res = await fetch(API + '/albums/' + id, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + this.state.jwt }
                    });
                    if(res.ok) {
                        this.showToast('Album został usunięty.', 'success');
                        this.loadDashboard();
                    } else {
                        throw new Error('Błąd usuwania');
                    }
                } catch (err) { this.showToast('Błąd: ' + err.message, 'error'); }
            },

            // Tworzenie albumu + Upload
            async createAlbum() {
                const btn = document.getElementById('uploadBtn');
                const statusDiv = document.getElementById('upload-status');
                btn.disabled = true; btn.innerText = "Przetwarzanie...";
                
                try {
                    const title = document.getElementById('albumTitle').value;
                    const clientName = document.getElementById('clientName').value;
                    const clientEmail = document.getElementById('clientEmailUpload').value;

                    // 1. Utwórz album w bazie
                    const res1 = await fetch(API + '/albums', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + this.state.jwt }, 
                        body: JSON.stringify({ title, clientName }) 
                    });
                    const albumData = await res1.json();
                    const albumId = albumData[0].id;
                    const accessToken = albumData[0].access_token;

                    // 2. Upload zdjęć
                    const files = document.getElementById('files').files;
                    const formData = new FormData();
                    formData.append('albumId', albumId);
                    for (let i = 0; i < files.length; i++) formData.append('photos', files[i]);

                    statusDiv.innerText = "Wysyłanie zdjęć (nie zamykaj)...";
                    const res2 = await fetch(API + '/upload', { 
                        method: 'POST', 
                        headers: { 'Authorization': 'Bearer ' + this.state.jwt }, 
                        body: formData 
                    });
                    
                    if(res2.ok) { 
                        if (clientEmail) {
                            statusDiv.innerText = "Wysyłanie maila...";
                            const link = window.location.origin + '/gallery/' + accessToken;
                            await fetch(API + '/send-link', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + this.state.jwt },
                                body: JSON.stringify({ clientEmail: clientEmail, albumTitle: title, link: link })
                            });
                            this.showToast('Wysłano do klienta!', 'success');
                        } else {
                            this.showToast('Gotowe!', 'success');
                        }
                        this.loadDashboard(); 
                    } else throw new Error('Błąd uploadu');
                } catch (err) { 
                    this.showToast(err.message, 'error');
                } finally { 
                    btn.disabled = false; btn.innerText = "Rozpocznij Upload"; statusDiv.innerText = "";
                }
            },

            // Widok Galerii (dla klienta)
            async loadGallery(token) {
                this.state.currentAlbumToken = token;
                router.go('gallery');
                try {
                    const res = await fetch(API + '/gallery/' + token);
                    if(!res.ok) throw new Error('Błąd');
                    const data = await res.json();
                    
                    document.getElementById('gallery-title').innerText = data.album[0].title;
                    document.getElementById('gallery-hero-title').innerText = data.album[0].title;
                    
                    this.state.selected = new Set(data.selections);
                    this.state.photos = data.photos;
                    this.renderGrid();
                    this.updateCounter();

                    if(!localStorage.getItem('visited_' + token)) {
                        this.showToast('Witaj! Wybierz zdjęcia klikając serce.', 'success');
                        localStorage.setItem('visited_' + token, 'true');
                    }
                } catch (err) { document.body.innerHTML = "<div style='text-align:center; padding:50px;'><h1>404</h1><p>Nie znaleziono galerii.</p></div>"; }
            },

            renderGrid() {
                const grid = document.getElementById('grid');
                if (this.state.photos.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; padding:40px; color:#888;">Galeria jest pusta.</p>';
                    return;
                }
                grid.innerHTML = this.state.photos.map((p, index) => {
                    const isSelected = this.state.selected.has(p.id) ? 'selected' : '';
                    return `
                    <div class="photo-card ${isSelected}" onclick="app.openLightbox(${index})">
                        <div class="heart-icon" onclick="event.stopPropagation(); app.toggleSelection(${index})">
                            ${isSelected ? '❤' : '♡'}
                        </div>
                        <img src="${p.proof_url}" loading="lazy" alt="Zdjęcie">
                    </div>`;
                }).join('');
            },

            toggleSelection(index) {
                const p = this.state.photos[index];
                if (this.state.selected.has(p.id)) this.state.selected.delete(p.id);
                else {
                    this.state.selected.add(p.id);
                    if(navigator.vibrate) navigator.vibrate(50); // Wibracja na telefonie
                }
                this.renderGrid();
                this.updateCounter();
            },

            openLightbox(index) {
                this.state.currentPhotoIndex = index;
                const p = this.state.photos[index];
                const box = document.getElementById('lightbox');
                document.getElementById('lightbox-img').src = p.proof_url;
                box.classList.add('active');
                this.updateLightboxUI();
            },
            closeLightbox() { document.getElementById('lightbox').classList.remove('active'); },
            
            nextPhoto() { 
                if (this.state.currentPhotoIndex < this.state.photos.length - 1) 
                    this.openLightbox(this.state.currentPhotoIndex + 1); 
            },
            prevPhoto() { 
                if (this.state.currentPhotoIndex > 0) 
                    this.openLightbox(this.state.currentPhotoIndex - 1); 
            },

            toggleSelectionFromLightbox() {
                const p = this.state.photos[this.state.currentPhotoIndex];
                if (this.state.selected.has(p.id)) this.state.selected.delete(p.id);
                else this.state.selected.add(p.id);
                this.updateLightboxUI();
                this.renderGrid();
                this.updateCounter();
            },

            updateLightboxUI() {
                const p = this.state.photos[this.state.currentPhotoIndex];
                const btn = document.getElementById('lb-select-btn');
                if (this.state.selected.has(p.id)) {
                    btn.classList.add('active');
                    btn.innerText = "❤ WYBRANE";
                } else {
                    btn.classList.remove('active');
                    btn.innerText = "Wybierz zdjęcie";
                }
            },

            updateCounter() { 
                document.getElementById('selection-count').innerText = `${this.state.selected.size} wybranych`; 
            },

            async saveSelection() {
                const btn = document.getElementById('saveBtn');
                btn.innerText = "Zapisywanie..."; btn.disabled = true;
                const token = this.state.currentAlbumToken;
                try {
                    await fetch(API + '/select', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ token: token, photoIds: Array.from(this.state.selected) }) 
                    });
                    this.showToast('Wybór wysłany do fotografa!', 'success');
                } catch (err) { 
                    this.showToast('Błąd zapisu.', 'error'); 
                } finally { 
                    btn.innerText = "Zatwierdź Wybór"; btn.disabled = false; 
                }
            }
        };

        // Start aplikacji
        app.init();
    </script>
</body>
</html>
