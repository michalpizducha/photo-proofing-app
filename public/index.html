<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julia Berlik Foto | Strefa Klienta</title>
    <meta name="description" content="Profesjonalna fotografia z pasjÄ… - wybierz swoje ulubione zdjÄ™cia">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    
    <!-- TOAST NOTIFICATIONS -->
    <div id="toast-container">
        <div id="toast-text">Komunikat</div>
    </div>

    <!-- LIGHTBOX Z FULLSCREEN -->
    <div id="lightbox">
        <div id="lb-close" class="lb-close" title="Zamknij (Esc)">&times;</div>
        <div id="lb-prev" class="lb-nav lb-prev" title="Poprzednie (â†)">&#10094;</div>
        <div id="lb-next" class="lb-nav lb-next" title="NastÄ™pne (â†’)">&#10095;</div>
        <div id="lb-fullscreen" class="lb-fullscreen" title="PeÅ‚ny ekran (F)">â›¶</div>
        <img id="lightbox-img" src="" alt="PodglÄ…d">
        <div class="lb-controls">
            <button id="lb-select-btn" class="lb-select-btn">Wybierz zdjÄ™cie</button>
            <div class="lb-counter"><span id="lb-current">1</span> / <span id="lb-total">1</span></div>
        </div>
    </div>

    <!-- NAVIGATION BAR -->
    <nav class="main-nav">
        <div class="nav-container">
            <div class="brand-logo">Julia Berlik <span>Foto</span></div>
            <button class="nav-toggle" id="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu" id="nav-menu">
                <li><a href="/" class="nav-link">Strona gÅ‚Ã³wna</a></li>
                <li><a href="#" class="nav-link" data-view="about">O mnie</a></li>
                <li><a href="#" class="nav-link" data-view="faq">FAQ</a></li>
                <li><a href="#" class="nav-link" data-view="my-sessions">Moje Sesje</a></li>
                <li><a href="#" class="nav-link" data-view="login">Panel Fotografa</a></li>
            </ul>
        </div>
    </nav>

    <!-- VIEW: LOGIN -->
    <div id="view-login" class="container hidden">
        <div class="card">
            <h2>Panel Fotografa</h2>
            <p class="text-muted mb-lg">Zaloguj siÄ™, aby zarzÄ…dzaÄ‡ sesjami</p>
            <form id="login-form">
                <input type="email" id="email" placeholder="Email" required autocomplete="username">
                <input type="password" id="password" placeholder="HasÅ‚o" required autocomplete="current-password">
                <button type="submit" class="btn-primary">Zaloguj siÄ™</button>
            </form>
        </div>
    </div>

    <!-- VIEW: DASHBOARD -->
    <div id="view-dashboard" class="container hidden fade-in">
        <header class="dashboard-header">
            <div>
                <h2>ZarzÄ…dzanie Sesjami</h2>
                <p class="text-muted">Panel administracyjny fotografa</p>
            </div>
            <div class="dashboard-actions">
                <button id="btn-new-session" class="btn-primary">+ Nowa Sesja</button>
                <button id="btn-logout" class="btn-secondary">Wyloguj</button>
            </div>
        </header>
        <div id="albums-list"></div>
    </div>

    <!-- VIEW: UPLOAD -->
    <div id="view-upload" class="container hidden fade-in">
        <button id="btn-upload-back" class="btn-secondary mb-lg">â† WrÃ³Ä‡ do panelu</button>
        <div class="card upload-card">
            <h2>UtwÃ³rz NowÄ… SesjÄ™</h2>
            <form id="upload-form">
                <label for="albumTitle">Nazwa Sesji</label>
                <input type="text" id="albumTitle" placeholder="np. Åšlub Ani i Marka" required>
                
                <label for="clientName">Klient</label>
                <input type="text" id="clientName" placeholder="ImiÄ™ i Nazwisko" required>
                
                <label for="clientEmailUpload">Email Klienta (Opcjonalnie)</label>
                <input type="email" id="clientEmailUpload" placeholder="Automatycznie wyÅ›lemy link do galerii">
                
                <!-- DRAG & DROP ZONE -->
                <div class="dropzone" id="dropzone">
                    <div class="dropzone-icon">ğŸ“¸</div>
                    <div class="dropzone-text">
                        <p><strong>PrzeciÄ…gnij zdjÄ™cia tutaj</strong></p>
                        <p class="text-muted">lub kliknij, aby wybraÄ‡ pliki</p>
                        <p class="text-muted mt-sm">Format: JPG/JPEG (max 25MB/plik)</p>
                    </div>
                    <input type="file" id="files" multiple accept="image/jpeg,image/jpg" style="display:none">
                </div>
                
                <div id="file-preview" class="file-preview"></div>
                
                <button type="submit" id="uploadBtn" class="btn-primary">Rozpocznij Upload</button>
            </form>
            
            <!-- PROGRESS BAR -->
            <div id="upload-progress" class="upload-progress hidden">
                <div class="progress-header">
                    <span id="progress-text">PrzesyÅ‚anie zdjÄ™Ä‡...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p class="text-muted mt-sm" id="progress-details">Przygotowywanie...</p>
            </div>
        </div>
    </div>

    <!-- VIEW: GALLERY -->
    <div id="view-gallery" class="hidden">
        <div class="container">
            <div class="gallery-container fade-in">
                <header class="gallery-header">
                    <div>
                        <h2 id="gallery-title">TytuÅ‚ Sesji</h2>
                        <p class="text-muted">Kliknij serce â¤ na zdjÄ™ciu, aby je wybraÄ‡</p>
                    </div>
                    <div class="gallery-header-actions">
                        <span id="selection-count">0 wybranych</span>
                        <button id="saveBtn" class="btn-primary">ZatwierdÅº WybÃ³r</button>
                    </div>
                </header>

                <div class="filters">
                    <button id="filter-all" class="filter-btn active" data-filter="all">Wszystkie</button>
                    <button id="filter-selected" class="filter-btn" data-filter="selected">Tylko Wybrane â¤</button>
                </div>
                
                <div id="grid" class="gallery-grid"></div>
            </div>
        </div>
    </div>

    <!-- VIEW: ABOUT -->
    <div id="view-about" class="container hidden fade-in">
        <div class="content-page">
            <div class="page-header">
                <h1>O mnie</h1>
                <div class="header-divider"></div>
            </div>
            
            <div class="about-content">
                <div class="about-image">
                    <img src="/logo.jpg" alt="Julia Berlik" class="profile-photo">
                </div>
                
                <div class="about-text">
                    <h3>Witaj w moim Å›wiecie fotografii!</h3>
                    <p>Jestem Julia Berlik â€“ fotografkÄ… z pasjÄ… do uchwycenia najpiÄ™kniejszych momentÃ³w w Å¼yciu. Od lat specjalizujÄ™ siÄ™ w fotografii Å›lubnej, portretowej i rodzinnej.</p>
                    
                    <p>Moja filozofia to naturalna elegancja i autentyczne emocje. WierzÄ™, Å¼e najlepsze zdjÄ™cia powstajÄ… wtedy, gdy czujesz siÄ™ komfortowo i moÅ¼esz byÄ‡ sobÄ….</p>
                    
                    <div class="feature-list">
                        <div class="feature-item">
                            <span class="feature-icon">ğŸ“¸</span>
                            <div>
                                <h4>Profesjonalne PodejÅ›cie</h4>
                                <p>Nowoczesny sprzÄ™t i doÅ›wiadczenie w branÅ¼y</p>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <span class="feature-icon">â¤ï¸</span>
                            <div>
                                <h4>Z PasjÄ…</h4>
                                <p>KaÅ¼da sesja to dla mnie wyjÄ…tkowe przeÅ¼ycie</p>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <span class="feature-icon">â­</span>
                            <div>
                                <h4>Indywidualne PodejÅ›cie</h4>
                                <p>DostosowujÄ™ siÄ™ do Twoich potrzeb i oczekiwaÅ„</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cta-section">
                        <h3>Gotowy na swojÄ… sesjÄ™?</h3>
                        <p>Skontaktuj siÄ™ ze mnÄ…, aby omÃ³wiÄ‡ szczegÃ³Å‚y</p>
                        <a href="mailto:kontakt@juliaberlik.pl" class="btn-primary">Napisz do mnie</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: FAQ -->
    <div id="view-faq" class="container hidden fade-in">
        <div class="content-page">
            <div class="page-header">
                <h1>CzÄ™sto Zadawane Pytania</h1>
                <div class="header-divider"></div>
                <p class="text-muted">Odpowiedzi na najczÄ™stsze pytania dotyczÄ…ce wyboru zdjÄ™Ä‡</p>
            </div>
            
            <div class="faq-list">
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Jak wybraÄ‡ zdjÄ™cia z galerii?</h3>
                        <span class="faq-icon">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>To bardzo proste! Kliknij na serce â¤ w prawym gÃ³rnym rogu zdjÄ™cia. Wybrane zdjÄ™cia bÄ™dÄ… miaÅ‚y zÅ‚otÄ… ramkÄ™. MoÅ¼esz przeglÄ…daÄ‡ zdjÄ™cia w trybie peÅ‚noekranowym, klikajÄ…c na nie.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Ile zdjÄ™Ä‡ mogÄ™ wybraÄ‡?</h3>
                        <span class="faq-icon">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Limit zaleÅ¼y od Twojego pakietu. Zazwyczaj jest to 30-50 zdjÄ™Ä‡ dla sesji standardowej lub 100-150 dla sesji Å›lubnej. Aktualny licznik wybranych zdjÄ™Ä‡ jest zawsze widoczny na gÃ³rze galerii.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Jak dÅ‚ugo mam dostÄ™p do galerii?</h3>
                        <span class="faq-icon">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Link do galerii jest aktywny przez 30 dni od daty otrzymania. Po tym czasie moÅ¼esz poprosiÄ‡ o ponowne udostÄ™pnienie.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Kiedy otrzymam gotowe zdjÄ™cia?</h3>
                        <span class="faq-icon">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Po zatwierdzeniu wyboru, zdjÄ™cia sÄ… obrabiane i wysyÅ‚ane mailem w ciÄ…gu 7-14 dni roboczych. Otrzymasz paczkÄ™ ZIP z peÅ‚nÄ… rozdzielczoÅ›ciÄ….</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Co jeÅ›li zmieniÄ™ zdanie?</h3>
                        <span class="faq-icon">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>MoÅ¼esz zmieniaÄ‡ wybÃ³r ile razy chcesz przed jego zatwierdzeniem. Po klikniÄ™ciu "ZatwierdÅº WybÃ³r" moÅ¼esz jeszcze poprosiÄ‡ o jednÄ… zmianÄ™ w ciÄ…gu 48h.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Jaka jest jakoÅ›Ä‡ zdjÄ™Ä‡ w galerii?</h3>
                        <span class="faq-icon">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>ZdjÄ™cia w galerii to wersje proof (wodny znak + zmniejszona rozdzielczoÅ›Ä‡) do wygodnego przeglÄ…dania. Gotowe, wybrane zdjÄ™cia otrzymasz w peÅ‚nej jakoÅ›ci bez znaku wodnego.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Czy mogÄ™ pobraÄ‡ wszystkie zdjÄ™cia?</h3>
                        <span class="faq-icon">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Galeria sÅ‚uÅ¼y tylko do wyboru zdjÄ™Ä‡. Otrzymasz wyÅ‚Ä…cznie te zdjÄ™cia, ktÃ³re wybierzesz i zatwierdzisz. JeÅ›li chcesz otrzymaÄ‡ wszystkie zdjÄ™cia z sesji, skontaktuj siÄ™ bezpoÅ›rednio - dostÄ™pne sÄ… specjalne pakiety.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: MY SESSIONS -->
    <div id="view-my-sessions" class="container hidden fade-in">
        <div class="content-page">
            <div class="page-header">
                <h1>Moje Sesje</h1>
                <div class="header-divider"></div>
                <p class="text-muted">Zobacz historiÄ™ swoich sesji fotograficznych</p>
            </div>
            
            <div class="session-lookup">
                <h3>ZnajdÅº swojÄ… sesjÄ™</h3>
                <p class="text-muted mb-md">Wpisz swÃ³j adres email, aby zobaczyÄ‡ wszystkie sesje</p>
                <form id="session-lookup-form" class="lookup-form">
                    <input type="email" id="lookup-email" placeholder="twoj@email.pl" required>
                    <button type="submit" class="btn-primary">Szukaj moich sesji</button>
                </form>
            </div>
            
            <div id="sessions-result" class="sessions-result"></div>
        </div>
    </div>

    <script>
        const API = '/api';

        // ROUTER
        const router = {
            views: ['login', 'dashboard', 'upload', 'gallery', 'about', 'faq', 'my-sessions'],
            go(viewId) {
                // Ukryj wszystkie widoki
                this.views.forEach(v => {
                    const el = document.getElementById('view-' + v);
                    if(el) el.classList.add('hidden');
                });
                
                // PokaÅ¼ aktywny
                const active = document.getElementById('view-' + viewId);
                if(active) {
                    active.classList.remove('hidden');
                    active.classList.add('fade-in');
                }
                
                // Aktualizuj aktywny link w nav
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if(link.dataset.view === viewId) link.classList.add('active');
                });
                
                // Scroll do gÃ³ry
                window.scrollTo(0, 0);
            }
        };

        const app = {
            state: { 
                selected: new Set(), 
                currentAlbumToken: null, 
                photos: [], 
                currentPhotoIndex: 0, 
                viewFilter: 'all', 
                MAX_SELECTION: 1000,
                uploadedFiles: []
            },

            async init() {
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.setupFAQ();
                
                const path = window.location.pathname;
                if (path.startsWith('/gallery/')) {
                    const token = path.split('/')[2];
                    if(token) this.loadGallery(token);
                } else {
                    try {
                        const res = await fetch(API + '/auth/check', { credentials: 'include' }); 
                        if(res.ok) this.loadDashboard();
                        else router.go('about'); // DomyÅ›lnie pokazuj "O mnie"
                    } catch(e) { router.go('about'); }
                }
            },

            setupEventListeners() {
                // Navigation
                document.getElementById('nav-toggle')?.addEventListener('click', () => {
                    document.getElementById('nav-menu').classList.toggle('active');
                });
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const view = link.dataset.view || 'about';
                        router.go(view);
                        document.getElementById('nav-menu').classList.remove('active');
                    });
                });

                // Forms
                document.getElementById('login-form')?.addEventListener('submit', (e) => { e.preventDefault(); this.login(); });
                document.getElementById('upload-form')?.addEventListener('submit', (e) => { e.preventDefault(); this.createAlbum(); });
                document.getElementById('session-lookup-form')?.addEventListener('submit', (e) => { e.preventDefault(); this.lookupSessions(); });
                
                // Buttons
                document.getElementById('btn-new-session')?.addEventListener('click', () => router.go('upload'));
                document.getElementById('btn-logout')?.addEventListener('click', () => this.logout());
                document.getElementById('btn-upload-back')?.addEventListener('click', () => router.go('dashboard'));
                document.getElementById('saveBtn')?.addEventListener('click', () => this.saveSelection());
                
                // Filters
                document.getElementById('filter-all')?.addEventListener('click', (e) => this.setFilter('all'));
                document.getElementById('filter-selected')?.addEventListener('click', (e) => this.setFilter('selected'));
                
                // Lightbox
                document.getElementById('lb-close')?.addEventListener('click', () => this.closeLightbox());
                document.getElementById('lb-prev')?.addEventListener('click', () => this.prevPhoto());
                document.getElementById('lb-next')?.addEventListener('click', () => this.nextPhoto());
                document.getElementById('lb-select-btn')?.addEventListener('click', () => this.toggleSelectionFromLightbox());
                document.getElementById('lb-fullscreen')?.addEventListener('click', () => this.toggleFullscreen());
                
                // Grid click handler
                document.getElementById('grid')?.addEventListener('click', (e) => {
                    const card = e.target.closest('.photo-card');
                    if (card) {
                        const originalIndex = parseInt(card.dataset.index);
                        if (e.target.closest('.heart-icon')) {
                            this.toggleSelection(originalIndex);
                        } else {
                            this.openLightbox(originalIndex);
                        }
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    const lightbox = document.getElementById('lightbox');
                    if (!lightbox.classList.contains('active')) return;
                    
                    if (e.key === 'ArrowLeft' || e.key === 'a') this.prevPhoto();
                    if (e.key === 'ArrowRight' || e.key === 'd') this.nextPhoto();
                    if (e.key === 'Escape') this.closeLightbox();
                    if (e.key === ' ') { e.preventDefault(); this.toggleSelectionFromLightbox(); }
                    if (e.key === 'f' || e.key === 'F') { e.preventDefault(); this.toggleFullscreen(); }
                });
                
                // Touch gestures for mobile
                this.setupTouchGestures();
                
                // Prevent right-click
                document.body.addEventListener('contextmenu', (e) => {
                    if(e.target.tagName === 'IMG') e.preventDefault();
                });
            },

            setupDragAndDrop() {
                const dropzone = document.getElementById('dropzone');
                const fileInput = document.getElementById('files');
                
                if(!dropzone || !fileInput) return;
                
                // Click to select
                dropzone.addEventListener('click', () => fileInput.click());
                
                // Drag events
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropzone.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropzone.addEventListener(eventName, () => {
                        dropzone.classList.add('dragover');
                    });
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropzone.addEventListener(eventName, () => {
                        dropzone.classList.remove('dragover');
                    });
                });
                
                dropzone.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    fileInput.files = files;
                    this.previewFiles(files);
                });
                
                fileInput.addEventListener('change', (e) => {
                    this.previewFiles(e.target.files);
                });
            },

            previewFiles(files) {
                const preview = document.getElementById('file-preview');
                preview.innerHTML = '';
                
                if(files.length === 0) return;
                
                const fileList = Array.from(files);
                const validFiles = fileList.filter(f => f.type.match('image/jpeg'));
                
                if(validFiles.length !== fileList.length) {
                    this.showToast('Tylko pliki JPG/JPEG sÄ… akceptowane', 'error');
                }
                
                preview.innerHTML = `
                    <div class="file-preview-summary">
                        <span class="file-count">ğŸ“¸ ${validFiles.length} zdjÄ™Ä‡ wybranych</span>
                        <span class="file-size">${this.formatBytes(validFiles.reduce((sum, f) => sum + f.size, 0))}</span>
                    </div>
                `;
            },

            formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            },

            setupTouchGestures() {
                const lightbox = document.getElementById('lightbox');
                let touchStartX = 0;
                let touchEndX = 0;
                
                lightbox.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });
                
                lightbox.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    this.handleSwipe();
                }, { passive: true });
                
                const handleSwipe = () => {
                    const swipeThreshold = 50;
                    if (touchEndX < touchStartX - swipeThreshold) {
                        this.nextPhoto(); // Swipe left
                    }
                    if (touchEndX > touchStartX + swipeThreshold) {
                        this.prevPhoto(); // Swipe right
                    }
                };
                
                this.handleSwipe = handleSwipe;
            },

            setupFAQ() {
                document.addEventListener('click', (e) => {
                    const question = e.target.closest('.faq-question');
                    if(question) {
                        const item = question.parentElement;
                        item.classList.toggle('active');
                    }
                });
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast-container');
                const text = document.getElementById('toast-text');
                text.innerText = message;
                toast.classList.add('active');
                
                if (type === 'error') {
                    toast.style.background = 'var(--color-error)';
                } else if (type === 'warning') {
                    toast.style.background = 'var(--color-warning)';
                } else {
                    toast.style.background = 'var(--color-primary)';
                }
                
                setTimeout(() => { toast.classList.remove('active'); }, 3500);
            },

            async login() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    const res = await fetch(API + '/auth/login', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ email, password }), 
                        credentials: 'include'
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    this.showToast('Zalogowano pomyÅ›lnie!', 'success');
                    this.loadDashboard();
                } catch (err) { 
                    this.showToast(err.message, 'error'); 
                }
            },

            async logout() { 
                await fetch(API + '/auth/logout', { method: 'POST', credentials: 'include' });
                this.showToast('Wylogowano', 'success');
                router.go('about'); 
            },

            async loadDashboard() {
                router.go('dashboard');
                try {
                    const res = await fetch(API + '/admin/albums', { credentials: 'include' });
                    const albums = await res.json();
                    const container = document.getElementById('albums-list');
                    
                    if(albums.length === 0) { 
                        container.innerHTML = '<div class="empty-state"><p>Brak albumÃ³w. UtwÃ³rz pierwszÄ… sesjÄ™!</p></div>'; 
                        return; 
                    }
                    
                    container.innerHTML = albums.map(a => `
                        <div class="album-item">
                            <div class="album-info">
                                <h3>${a.title}</h3>
                                <p class="text-muted">
                                    ${a.client_name} â€¢ ${a.photo_count || 0} zdjÄ™Ä‡ â€¢ 
                                    <strong style="color: var(--color-accent)">Wybrano: ${a.selection_count || 0}</strong>
                                </p>
                            </div>
                            <div class="album-actions">
                                <button class="btn-copy" data-album-id="${a.id}">ğŸ“‹ Nazwy</button>
                                <button class="btn-auto-send" 
                                    data-id="${a.id}" 
                                    data-title="${a.title}"
                                    data-client="${a.client_name}"
                                    data-selected="${a.selection_count}">
                                    ğŸ Spakuj i WyÅ›lij
                                </button>
                                <a href="/gallery/${a.access_token}" target="_blank">
                                    <button class="btn-secondary">ğŸ‘ PodglÄ…d</button>
                                </a>
                                <button class="btn-danger btn-delete-album" data-album-id="${a.id}">ğŸ—‘ UsuÅ„</button>
                            </div>
                        </div>
                    `).join('');
                    
                    // Event listeners
                    document.querySelectorAll('.btn-copy').forEach(btn => {
                        btn.addEventListener('click', () => this.copyFilenames(btn.dataset.albumId));
                    });
                    
                    document.querySelectorAll('.btn-delete-album').forEach(btn => {
                        btn.addEventListener('click', () => this.deleteAlbum(btn.dataset.albumId));
                    });

                    document.querySelectorAll('.btn-auto-send').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const id = btn.dataset.id;
                            const title = btn.dataset.title;
                            const count = parseInt(btn.dataset.selected);

                            if(count === 0) {
                                return this.showToast('Klient nie wybraÅ‚ jeszcze Å¼adnych zdjÄ™Ä‡!', 'warning');
                            }
                            
                            const email = prompt(`Podaj email klienta (${btn.dataset.client}), aby wysÅ‚aÄ‡ paczkÄ™ ZIP (${count} zdjÄ™Ä‡):`);
                            if(!email) return;

                            btn.innerText = "â³ Pakowanie...";
                            btn.disabled = true;
                            this.showToast('Serwer pakuje zdjÄ™cia... To moÅ¼e potrwaÄ‡ chwilÄ™.', 'success');

                            try {
                                const resZip = await fetch(API + '/auto-deliver', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ albumId: id }),
                                    credentials: 'include'
                                });
                                
                                if(!resZip.ok) {
                                    const err = await resZip.json();
                                    throw new Error(err.error || 'BÅ‚Ä…d pakowania');
                                }
                                
                                const dataZip = await resZip.json();
                                btn.innerText = "ğŸ“§ WysyÅ‚anie...";

                                const resMail = await fetch(API + '/send-delivery', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ 
                                        clientEmail: email, 
                                        albumTitle: title, 
                                        clientName: btn.dataset.client,
                                        downloadLink: dataZip.downloadLink 
                                    }),
                                    credentials: 'include'
                                });

                                if(resMail.ok) {
                                    this.showToast(`âœ… WysÅ‚ano link do ${count} zdjÄ™Ä‡ na ${email}`, 'success');
                                } else {
                                    throw new Error('ZIP utworzony, ale bÅ‚Ä…d wysyÅ‚ki maila');
                                }

                            } catch (e) {
                                console.error(e);
                                this.showToast('BÅ‚Ä…d: ' + e.message, 'error');
                            } finally {
                                btn.innerText = "ğŸ Spakuj i WyÅ›lij";
                                btn.disabled = false;
                            }
                        });
                    });

                } catch (err) { 
                    console.error(err); 
                    this.showToast('BÅ‚Ä…d Å‚adowania albumÃ³w', 'error');
                }
            },

            async copyFilenames(albumId) {
                try {
                    const res = await fetch(API + '/admin/albums/' + albumId + '/files', { credentials: 'include' });
                    const data = await res.json();
                    if(data.filenames?.length > 0) {
                        await navigator.clipboard.writeText(data.filenames.join(', ')); 
                        this.showToast('Skopiowano listÄ™ nazw!', 'success');
                    } else { 
                        this.showToast('Brak zdjÄ™Ä‡ do skopiowania', 'error'); 
                    }
                } catch (err) { 
                    this.showToast('Funkcja niedostÄ™pna w tej przeglÄ…darce', 'error'); 
                }
            },

            async deleteAlbum(id) {
                if(!confirm('Czy na pewno chcesz usunÄ…Ä‡ ten album? Ta operacja jest nieodwracalna.')) return;
                
                try {
                    const res = await fetch(API + '/albums/' + id, { 
                        method: 'DELETE', 
                        credentials: 'include' 
                    });
                    
                    if(res.ok) { 
                        this.showToast('Album usuniÄ™ty', 'success'); 
                        this.loadDashboard(); 
                    } else {
                        throw new Error('BÅ‚Ä…d usuwania');
                    }
                } catch (err) { 
                    this.showToast('BÅ‚Ä…d usuwania albumu', 'error'); 
                }
            },

            async createAlbum() {
                const btn = document.getElementById('uploadBtn');
                const progressDiv = document.getElementById('upload-progress');
                const progressFill = document.getElementById('progress-fill');
                const progressPercent = document.getElementById('progress-percent');
                const progressText = document.getElementById('progress-text');
                const progressDetails = document.getElementById('progress-details');
                
                const title = document.getElementById('albumTitle').value;
                const clientName = document.getElementById('clientName').value;
                const clientEmail = document.getElementById('clientEmailUpload').value;
                const filesInput = document.getElementById('files');
                const files = Array.from(filesInput.files);

                if(files.length === 0) return this.showToast('Wybierz zdjÄ™cia', 'error');
                
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Przetwarzanie...';
                progressDiv.classList.remove('hidden');
                
                try {
                    // 1. Create album
                    progressText.innerText = 'Tworzenie albumu...';
                    progressDetails.innerText = 'Krok 1/3';
                    progressFill.style.width = '10%';
                    progressPercent.innerText = '10%';
                    
                    const res1 = await fetch(API + '/albums', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ title, clientName }), 
                        credentials: 'include'
                    });
                    
                    if(!res1.ok) throw new Error('BÅ‚Ä…d tworzenia albumu');
                    const albumData = await res1.json();
                    const albumId = albumData.id;
                    const accessToken = albumData.access_token;

                    // 2. Upload files
                    progressText.innerText = 'WysyÅ‚anie zdjÄ™Ä‡...';
                    progressDetails.innerText = 'Krok 2/3';
                    
                    const BATCH_SIZE = 3;
                    let uploaded = 0;
                    
                    for (let i = 0; i < files.length; i += BATCH_SIZE) {
                        const chunk = files.slice(i, i + BATCH_SIZE);
                        const formData = new FormData();
                        formData.append('albumId', albumId);
                        chunk.forEach(f => formData.append('photos', f));
                        
                        const progress = Math.round(10 + (uploaded / files.length) * 70);
                        progressFill.style.width = progress + '%';
                        progressPercent.innerText = progress + '%';
                        progressDetails.innerText = `WysÅ‚ano ${uploaded} z ${files.length} zdjÄ™Ä‡...`;
                        
                        const resUpload = await fetch(API + '/upload', { 
                            method: 'POST', 
                            body: formData, 
                            credentials: 'include' 
                        });
                        
                        if(!resUpload.ok) throw new Error('BÅ‚Ä…d uploadu');
                        uploaded += chunk.length;
                    }
                    
                    progressFill.style.width = '90%';
                    progressPercent.innerText = '90%';

                    // 3. Send email
                    if (clientEmail) {
                        progressText.innerText = 'WysyÅ‚anie maila do klienta...';
                        progressDetails.innerText = 'Krok 3/3';
                        
                        const link = window.location.origin + '/gallery/' + accessToken;
                        
                        const resMail = await fetch(API + '/send-link', { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ clientEmail, albumTitle: title, link }), 
                            credentials: 'include'
                        });

                        if (!resMail.ok) {
                            const errData = await resMail.json();
                            throw new Error('Album utworzony, ale bÅ‚Ä…d wysyÅ‚ki maila: ' + (errData.error || ''));
                        }
                    }
                    
                    progressFill.style.width = '100%';
                    progressPercent.innerText = '100%';
                    progressText.innerText = 'Gotowe!';
                    progressDetails.innerText = 'Sesja zostaÅ‚a utworzona';
                    
                    this.showToast('Sesja utworzona pomyÅ›lnie!', 'success');
                    
                    setTimeout(() => {
                        this.loadDashboard();
                        progressDiv.classList.add('hidden');
                    }, 1500);
                    
                } catch (err) { 
                    progressText.innerText = 'BÅ‚Ä…d: ' + err.message;
                    this.showToast('WystÄ…piÅ‚ bÅ‚Ä…d podczas tworzenia sesji', 'error'); 
                    console.error(err);
                } finally { 
                    btn.disabled = false; 
                    btn.innerText = "Rozpocznij Upload"; 
                }
            },

            async loadGallery(token) {
                this.state.currentAlbumToken = token;
                router.go('gallery');
                
                try {
                    const res = await fetch(API + '/gallery/' + token);
                    if(!res.ok) throw new Error('Nie znaleziono galerii');
                    
                    const data = await res.json();
                    document.getElementById('gallery-title').innerText = data.album[0].title;
                    this.state.selected = new Set(data.selections);
                    this.state.photos = data.photos;
                    
                    this.renderGrid();
                    this.updateCounter();
                    
                } catch (e) { 
                    document.getElementById('view-gallery').innerHTML = `
                        <div class="container">
                            <div class="empty-state">
                                <h1>404</h1>
                                <p>Nie znaleziono galerii. SprawdÅº link lub skontaktuj siÄ™ z fotografem.</p>
                            </div>
                        </div>
                    `;
                }
            },

            renderGrid() {
                const grid = document.getElementById('grid');
                const filter = this.state.viewFilter;
                
                const photosToShow = filter === 'all' 
                    ? this.state.photos 
                    : this.state.photos.filter(p => this.state.selected.has(p.id));
                
                grid.innerHTML = photosToShow.map((p, i) => {
                    const originalIndex = this.state.photos.indexOf(p);
                    const sel = this.state.selected.has(p.id) ? 'selected' : '';
                    return `
                        <div class="photo-card ${sel}" data-index="${originalIndex}">
                            <div class="heart-icon">${sel ? 'â¤' : 'â™¡'}</div>
                            <img src="${p.proof_url}" loading="lazy" alt="ZdjÄ™cie ${originalIndex + 1}">
                        </div>
                    `;
                }).join('');
            },

            toggleSelection(i) {
                const p = this.state.photos[i];
                
                if(this.state.selected.has(p.id)) {
                    this.state.selected.delete(p.id);
                } else {
                    if(this.state.selected.size >= this.state.MAX_SELECTION) {
                        return this.showToast('OsiÄ…gniÄ™to limit wyboru!', 'warning');
                    }
                    this.state.selected.add(p.id);
                }
                
                this.renderGrid();
                this.updateCounter();
            },

            updateCounter() {
                document.getElementById('selection-count').innerText = `${this.state.selected.size} wybranych`;
            },

            async saveSelection() {
                if(this.state.selected.size === 0) {
                    return this.showToast('Wybierz przynajmniej jedno zdjÄ™cie', 'warning');
                }
                
                try {
                    const res = await fetch(API + '/select', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            token: this.state.currentAlbumToken, 
                            photoIds: Array.from(this.state.selected) 
                        })
                    });
                    
                    if(res.ok) {
                        this.showToast('âœ… WybÃ³r zapisany! Fotograf zostaÅ‚ powiadomiony.', 'success');
                    } else {
                        throw new Error('BÅ‚Ä…d zapisu');
                    }
                } catch(e) { 
                    this.showToast('BÅ‚Ä…d zapisu wyboru', 'error'); 
                }
            },

            setFilter(type) {
                this.state.viewFilter = type;
                
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('filter-' + type).classList.add('active');
                
                this.renderGrid();
            },

            openLightbox(i) {
                this.state.currentPhotoIndex = i;
                const lightbox = document.getElementById('lightbox');
                const img = document.getElementById('lightbox-img');
                const p = this.state.photos[i];
                
                img.src = p.proof_url;
                lightbox.classList.add('active');
                
                this.updateLightboxBtn();
                this.updateLightboxCounter();
                
                // Preload next images
                if(i < this.state.photos.length - 1) {
                    const nextImg = new Image();
                    nextImg.src = this.state.photos[i + 1].proof_url;
                }
            },

            closeLightbox() {
                document.getElementById('lightbox').classList.remove('active');
                if(document.fullscreenElement) {
                    document.exitFullscreen();
                }
            },

            nextPhoto() {
                if(this.state.currentPhotoIndex < this.state.photos.length - 1) {
                    this.openLightbox(this.state.currentPhotoIndex + 1);
                }
            },

            prevPhoto() {
                if(this.state.currentPhotoIndex > 0) {
                    this.openLightbox(this.state.currentPhotoIndex - 1);
                }
            },

            toggleSelectionFromLightbox() {
                this.toggleSelection(this.state.currentPhotoIndex);
                this.updateLightboxBtn();
            },

            updateLightboxBtn() {
                const btn = document.getElementById('lb-select-btn');
                const p = this.state.photos[this.state.currentPhotoIndex];
                
                if(this.state.selected.has(p.id)) {
                    btn.classList.add('active');
                    btn.innerText = "Wybrano â¤";
                } else {
                    btn.classList.remove('active');
                    btn.innerText = "Wybierz zdjÄ™cie";
                }
            },

            updateLightboxCounter() {
                document.getElementById('lb-current').innerText = this.state.currentPhotoIndex + 1;
                document.getElementById('lb-total').innerText = this.state.photos.length;
            },

            toggleFullscreen() {
                const lightbox = document.getElementById('lightbox');
                
                if (!document.fullscreenElement) {
                    lightbox.requestFullscreen().catch(err => {
                        this.showToast('Nie moÅ¼na wÅ‚Ä…czyÄ‡ trybu peÅ‚noekranowego', 'error');
                    });
                } else {
                    document.exitFullscreen();
                }
            },

            async lookupSessions() {
                const email = document.getElementById('lookup-email').value;
                const resultDiv = document.getElementById('sessions-result');
                
                resultDiv.innerHTML = '<p class="text-center text-muted">Szukam sesji...</p>';
                
                try {
                    const res = await fetch(API + '/sessions/lookup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    
                    if(!res.ok) throw new Error('BÅ‚Ä…d wyszukiwania');
                    
                    const sessions = await res.json();
                    
                    if(sessions.length === 0) {
                        resultDiv.innerHTML = `
                            <div class="empty-state">
                                <p>Nie znaleziono Å¼adnych sesji dla tego adresu email.</p>
                                <p class="text-muted mt-sm">SprawdÅº poprawnÅ›Ä‡ adresu lub skontaktuj siÄ™ z fotografem.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    resultDiv.innerHTML = `
                        <h3 class="mb-md">Twoje Sesje (${sessions.length})</h3>
                        <div class="sessions-list">
                            ${sessions.map(s => `
                                <div class="session-card">
                                    <div class="session-info">
                                        <h4>${s.title}</h4>
                                        <p class="text-muted">
                                            ${new Date(s.created_at).toLocaleDateString('pl-PL')} â€¢ 
                                            ${s.photo_count} zdjÄ™Ä‡ â€¢ 
                                            <span style="color: var(--color-accent)">${s.selection_count} wybranych</span>
                                        </p>
                                    </div>
                                    <a href="/gallery/${s.access_token}" class="btn-primary">OtwÃ³rz GaleriÄ™</a>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                } catch(err) {
                    resultDiv.innerHTML = `
                        <div class="empty-state">
                            <p>WystÄ…piÅ‚ bÅ‚Ä…d podczas wyszukiwania sesji.</p>
                        </div>
                    `;
                }
            }
        };

        // Initialize app
        app.init();
    </script>
</body>
</html>