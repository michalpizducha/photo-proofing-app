<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julia Berlik Foto | Strefa Klienta</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    
    <div id="toast-container">
        <div id="toast-text">Komunikat</div>
    </div>

    <div id="lightbox">
        <div id="lb-close" class="lb-close">&times;</div>
        <div id="lb-prev" class="lb-nav lb-prev">&#10094;</div>
        <div id="lb-next" class="lb-nav lb-next">&#10095;</div>
        <img id="lightbox-img" src="" alt="PodglƒÖd">
        <div class="lb-controls">
            <button id="lb-select-btn" class="lb-select-btn">Wybierz zdjƒôcie</button>
        </div>
    </div>

    <div class="brand-title">
        Julia Berlik <span>Foto</span>
    </div>

    <div id="view-login" class="container hidden">
        <div class="card">
            <h2>Panel Fotografa</h2>
            <p style="color:#888; margin-bottom:20px;">Zaloguj siƒô, aby zarzƒÖdzaƒá sesjami</p>
            <form id="login-form">
                <input type="email" id="email" placeholder="Email" required value="admin@example.com" autocomplete="username">
                <input type="password" id="password" placeholder="Has≈Ço" required value="admin123" autocomplete="current-password">
                <button type="submit" style="width:100%">Wejd≈∫</button>
            </form>
        </div>
    </div>

    <div id="view-dashboard" class="container hidden fade-in">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h3>ZarzƒÖdzanie Sesjami</h3>
            <div>
                <button id="btn-new-session">+ Nowa Sesja</button>
                <button id="btn-logout" style="background:#eee; color:#333; margin-left:10px;">Wyloguj</button>
            </div>
        </header>
        <div id="albums-list"></div>
    </div>

    <div id="view-upload" class="container hidden fade-in">
        <button id="btn-upload-back" style="background:transparent; color:#333; border:1px solid #ddd; margin-bottom:20px;">‚Üê Wr√≥ƒá</button>
        <div class="card" style="max-width:800px;">
            <h2>Utw√≥rz Sesjƒô</h2>
            <form id="upload-form">
                <label for="albumTitle">Nazwa Sesji</label>
                <input type="text" id="albumTitle" placeholder="np. ≈ölub Ani" required>
                
                <label for="clientName">Klient</label>
                <input type="text" id="clientName" placeholder="Imiƒô i Nazwisko" required>
                
                <label for="clientEmailUpload">Email (Opcjonalnie)</label>
                <input type="email" id="clientEmailUpload" placeholder="Je≈õli podasz, wy≈õlemy link">
                
                <div style="border:2px dashed #ddd; padding:30px; margin:20px 0;">
                    <label for="files" style="display:block; margin-bottom:10px;">Wybierz pliki JPG (System automatycznie podzieli upload)</label>
                    <input type="file" id="files" multiple accept="image/jpeg" required>
                </div>
                <button type="submit" id="uploadBtn" style="width:100%">Rozpocznij Upload</button>
            </form>
            <div id="upload-status" style="margin-top:20px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="view-gallery" class="hidden">
        <div class="container">
            <div class="gallery-container fade-in">
                <header class="gallery-header">
                    <div>
                        <h2 id="gallery-title" style="font-size:1.5rem; margin:0;">Tytu≈Ç</h2>
                        <p style="font-size:0.9rem; color:#888;">Kliknij serce na zdjƒôciu, aby je wybraƒá.</p>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:flex-end;">
                        <span id="selection-count" style="font-weight:bold; color:var(--accent); font-size:1.2rem;">0 wybranych</span>
                        <button id="saveBtn">Zatwierd≈∫ Wyb√≥r</button>
                    </div>
                </header>

                <div class="filters">
                    <button id="filter-all" class="filter-btn active" data-filter="all">Wszystkie</button>
                    <button id="filter-selected" class="filter-btn" data-filter="selected">Tylko Wybrane ‚ù§</button>
                </div>
                
                <div id="grid" class="gallery-grid"></div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';

        const router = {
            views: ['login', 'dashboard', 'upload', 'gallery'],
            go(viewId) {
                this.views.forEach(v => {
                    const el = document.getElementById('view-' + v);
                    if(el) el.classList.add('hidden');
                });
                const active = document.getElementById('view-' + viewId);
                if(active) active.classList.remove('hidden');
                if(viewId === 'gallery') document.querySelector('.brand-title').style.display = 'block';
            }
        };

        const app = {
            state: { selected: new Set(), currentAlbumToken: null, photos: [], currentPhotoIndex: 0, viewFilter: 'all', MAX_SELECTION: 1000 }, // Zwiƒôkszy≈Çem limit selekcji

            async init() {
                this.setupEventListeners();
                const path = window.location.pathname;
                if (path.startsWith('/gallery/')) {
                    const token = path.split('/')[2];
                    if(token) this.loadGallery(token);
                } else {
                    try {
                        const res = await fetch(API + '/auth/check', { credentials: 'include' }); 
                        if(res.ok) this.loadDashboard();
                        else router.go('login');
                    } catch(e) { router.go('login'); }
                }
            },

            setupEventListeners() {
                document.getElementById('login-form')?.addEventListener('submit', (e) => { e.preventDefault(); this.login(); });
                document.getElementById('upload-form')?.addEventListener('submit', (e) => { e.preventDefault(); this.createAlbum(); });
                document.getElementById('btn-new-session')?.addEventListener('click', () => router.go('upload'));
                document.getElementById('btn-logout')?.addEventListener('click', () => this.logout());
                document.getElementById('btn-upload-back')?.addEventListener('click', () => router.go('dashboard'));
                document.getElementById('saveBtn')?.addEventListener('click', () => this.saveSelection());
                document.getElementById('filter-all')?.addEventListener('click', (e) => this.setFilter(e.target.dataset.filter));
                document.getElementById('filter-selected')?.addEventListener('click', (e) => this.setFilter(e.target.dataset.filter));
                document.getElementById('lb-close')?.addEventListener('click', () => this.closeLightbox());
                document.getElementById('lb-prev')?.addEventListener('click', () => this.prevPhoto());
                document.getElementById('lb-next')?.addEventListener('click', () => this.nextPhoto());
                document.getElementById('lb-select-btn')?.addEventListener('click', () => this.toggleSelectionFromLightbox());
                
                // Obs≈Çuga gridu
                document.getElementById('grid')?.addEventListener('click', (e) => {
                    const card = e.target.closest('.photo-card');
                    if (card) {
                        const originalIndex = card.dataset.index;
                        if (e.target.closest('.heart-icon')) {
                            this.toggleSelection(parseInt(originalIndex));
                        } else {
                            this.openLightbox(parseInt(originalIndex));
                        }
                    }
                });
                
                // Klawisze
                document.addEventListener('keydown', (e) => {
                    if (!document.getElementById('lightbox').classList.contains('active')) return;
                    if (e.key === 'ArrowLeft') this.prevPhoto();
                    if (e.key === 'ArrowRight') this.nextPhoto();
                    if (e.key === 'Escape') this.closeLightbox();
                    if (e.key === ' ') { e.preventDefault(); this.toggleSelectionFromLightbox(); }
                });
                document.body.addEventListener('contextmenu', (e) => e.preventDefault());
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast-container');
                const text = document.getElementById('toast-text');
                text.innerText = message;
                toast.classList.add('active');
                if (type === 'error') toast.style.background = '#ef4444';
                else toast.style.background = '#1a1a1a';
                setTimeout(() => { toast.classList.remove('active'); }, 3500);
            },

            async login() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    const res = await fetch(API + '/auth/login', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ email, password }), credentials: 'include'
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    this.loadDashboard();
                } catch (err) { alert(err.message); }
            },

            async logout() { 
                await fetch(API + '/auth/logout', { method: 'POST', credentials: 'include' });
                router.go('login'); 
            },

            // --- G≈Å√ìWNA ZMIANA: NOWY DASHBOARD Z PRZYCISKIEM PAKOWANIA ---
            async loadDashboard() {
                router.go('dashboard');
                try {
                    const res = await fetch(API + '/admin/albums', { credentials: 'include' });
                    const albums = await res.json();
                    const container = document.getElementById('albums-list');
                    if(albums.length === 0) { container.innerHTML = '<p style="text-align:center; color:#888;">Brak album√≥w.</p>'; return; }
                    
                    container.innerHTML = albums.map(a => `
                        <div style="background:white; padding:20px; margin-bottom:15px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                            <div style="margin-bottom:10px;">
                                <h3 style="margin:0 0 5px 0; font-size:1.2rem;">${a.title}</h3>
                                <p style="color:#666; font-size:0.9rem; margin:0;">${a.client_name} ‚Ä¢ ${a.photo_count || 0} zdjƒôƒá ‚Ä¢ <strong style="color:var(--accent)">Wybrano: ${a.selection_count || 0}</strong></p>
                            </div>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button data-album-id="${a.id}" class="btn-copy btn-copy-filenames">üìã Nazwy</button>
                                
                                <button class="btn-auto-send" 
                                    data-id="${a.id}" 
                                    data-title="${a.title}"
                                    data-client="${a.client_name}"
                                    data-selected="${a.selection_count}"
                                    style="background:#1a1a1a; border:1px solid #1a1a1a;">
                                    üéÅ Spakuj i Wy≈õlij
                                </button>
                                
                                <a href="/gallery/${a.access_token}" target="_blank"><button style="background:transparent; color:#333; border:1px solid #ddd;">PodglƒÖd</button></a>
                                <button data-album-id="${a.id}" class="btn-danger btn-delete-album">Usu≈Ñ</button>
                            </div>
                        </div>`).join('');
                    
                    // Event Listenery
                    document.querySelectorAll('.btn-copy-filenames').forEach(btn => btn.addEventListener('click', () => this.copyFilenames(btn.dataset.albumId)));
                    document.querySelectorAll('.btn-delete-album').forEach(btn => btn.addEventListener('click', () => this.deleteAlbum(btn.dataset.albumId)));

                    // --- LOGIKA AUTOMATU (ZIP + MAIL) ---
                    document.querySelectorAll('.btn-auto-send').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const id = btn.dataset.id;
                            const title = btn.dataset.title;
                            const count = parseInt(btn.dataset.selected);

                            if(count === 0) return alert('Klient nie wybra≈Ç jeszcze ≈ºadnych zdjƒôƒá! Nie ma co pakowaƒá.');
                            
                            const email = prompt(`Podaj email klienta (${btn.dataset.client}), aby wys≈Çaƒá paczkƒô ZIP (${count} zdjƒôƒá):`);
                            if(!email) return;

                            btn.innerText = "‚è≥ Pakowanie...";
                            btn.disabled = true;
                            this.showToast('Serwer pakuje zdjƒôcia... To mo≈ºe potrwaƒá do minuty.', 'success');

                            try {
                                // 1. Generuj ZIP na serwerze
                                const resZip = await fetch(API + '/auto-deliver', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ albumId: id }),
                                    credentials: 'include'
                                });
                                
                                if(!resZip.ok) {
                                    const err = await resZip.json();
                                    throw new Error(err.error || 'B≈ÇƒÖd pakowania');
                                }
                                
                                const dataZip = await resZip.json();
                                btn.innerText = "üìß Wysy≈Çanie...";

                                // 2. Wy≈õlij Maila z linkiem do ZIP
                                const resMail = await fetch(API + '/send-delivery', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ 
                                        clientEmail: email, 
                                        albumTitle: title, 
                                        clientName: btn.dataset.client,
                                        downloadLink: dataZip.downloadLink 
                                    }),
                                    credentials: 'include'
                                });

                                if(resMail.ok) {
                                    alert(`‚úÖ Sukces! Wys≈Çano link do pobrania paczki ZIP (${dataZip.count} zdjƒôƒá) na adres ${email}.`);
                                } else {
                                    throw new Error('ZIP utworzony, ale wystƒÖpi≈Ç b≈ÇƒÖd przy wysy≈Çce maila.');
                                }

                            } catch (e) {
                                console.error(e);
                                alert('B≈ÇƒÖd: ' + e.message);
                            } finally {
                                btn.innerText = "üéÅ Spakuj i Wy≈õlij";
                                btn.disabled = false;
                            }
                        });
                    });

                } catch (err) { console.error(err); }
            },

            async copyFilenames(albumId) {
                try {
                    const res = await fetch(API + '/admin/albums/' + albumId + '/files', { credentials: 'include' });
                    // Je≈õli ten endpoint nie istnieje w serwerze, trzeba go dodaƒá lub zignorowaƒá
                    // W Twoim kodzie server.js go nie widzƒô, ale funkcja by≈Ça w oryginale.
                    // Zak≈Çadam ≈ºe to funkcja dodatkowa. Je≈õli nie zadzia≈Ça, to nic nie zepsuje.
                    const data = await res.json();
                    if(data.filenames?.length > 0) {
                        navigator.clipboard.writeText(data.filenames.join(', ')); this.showToast('Skopiowano listƒô!', 'success');
                    } else { this.showToast('B≈ÇƒÖd kopiowania lub brak zdjƒôƒá.', 'error'); }
                } catch (err) { this.showToast('Funkcja kopiowania niedostƒôpna.', 'error'); }
            },

            async deleteAlbum(id) {
                if(!confirm('Czy na pewno chcesz usunƒÖƒá ten album?')) return;
                try {
                    const res = await fetch(API + '/albums/' + id, { method: 'DELETE', credentials: 'include' });
                    if(res.ok) { this.showToast('Usuniƒôto.', 'success'); this.loadDashboard(); }
                } catch (err) { this.showToast('B≈ÇƒÖd usuwania.', 'error'); }
            },

            async createAlbum() {
                const btn = document.getElementById('uploadBtn');
                const statusDiv = document.getElementById('upload-status');
                const title = document.getElementById('albumTitle').value;
                const clientName = document.getElementById('clientName').value;
                const clientEmail = document.getElementById('clientEmailUpload').value;
                const filesInput = document.getElementById('files');
                const files = Array.from(filesInput.files);

                if(files.length === 0) return this.showToast('Wybierz zdjƒôcia', 'error');
                btn.disabled = true; btn.innerText = "Przetwarzanie...";
                
                try {
                    // 1. Album
                    const res1 = await fetch(API + '/albums', { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ title, clientName }), credentials: 'include'
                    });
                    if(!res1.ok) throw new Error('B≈ÇƒÖd tworzenia albumu');
                    const albumData = await res1.json();
                    const albumId = albumData.id;
                    const accessToken = albumData.access_token;

                    // 2. Upload
                    const BATCH_SIZE = 3; let uploaded = 0;
                    for (let i = 0; i < files.length; i += BATCH_SIZE) {
                        const chunk = files.slice(i, i + BATCH_SIZE);
                        const formData = new FormData();
                        formData.append('albumId', albumId);
                        chunk.forEach(f => formData.append('photos', f));
                        const progress = Math.round((uploaded / files.length) * 100);
                        statusDiv.innerHTML = `Wysy≈Çanie: ${progress}%`;
                        const resUpload = await fetch(API + '/upload', { method: 'POST', body: formData, credentials: 'include' });
                        if(!resUpload.ok) throw new Error('B≈ÇƒÖd uploadu');
                        uploaded += chunk.length;
                    }
                    statusDiv.innerHTML = "Wysy≈Çanie plik√≥w zako≈Ñczone!";

                    // 3. Email Powitalny (ten pierwszy, z linkiem do galerii)
                    if (clientEmail) {
                        statusDiv.innerText += " Wysy≈Çanie maila...";
                        const link = window.location.origin + '/gallery/' + accessToken;
                        
                        const resMail = await fetch(API + '/send-link', { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ clientEmail, albumTitle: title, link }), credentials: 'include'
                        });

                        if (!resMail.ok) {
                            const errData = await resMail.json();
                            throw new Error('Serwer odrzuci≈Ç maila: ' + (errData.error || 'Nieznany b≈ÇƒÖd'));
                        }
                        this.showToast('Wys≈Çano do klienta!', 'success');
                    } else { this.showToast('Gotowe!', 'success'); }
                    
                    setTimeout(() => this.loadDashboard(), 1500);
                } catch (err) { 
                    statusDiv.innerText = "B≈ÇƒÖd: " + err.message;
                    this.showToast('WystƒÖpi≈Ç b≈ÇƒÖd!', 'error'); 
                    console.error(err);
                } finally { btn.disabled = false; btn.innerText = "Rozpocznij Upload"; }
            },

            async loadGallery(token) {
                this.state.currentAlbumToken = token; router.go('gallery');
                try {
                    const res = await fetch(API + '/gallery/' + token); if(!res.ok) throw new Error();
                    const data = await res.json();
                    document.getElementById('gallery-title').innerText = data.album[0].title;
                    this.state.selected = new Set(data.selections); this.state.photos = data.photos;
                    this.renderGrid(); this.updateCounter();
                } catch (e) { document.getElementById('view-gallery').innerHTML = "<h1>404</h1><p>Nie znaleziono galerii.</p>"; }
            },
            renderGrid() {
                const grid = document.getElementById('grid');
                grid.innerHTML = this.state.photos.map((p, i) => {
                    const sel = this.state.selected.has(p.id) ? 'selected' : '';
                    return `<div class="photo-card ${sel}" data-index="${i}"><div class="heart-icon">${sel?'‚ù§':'‚ô°'}</div><img src="${p.proof_url}" loading="lazy"></div>`;
                }).join('');
            },
            toggleSelection(i) {
                const p = this.state.photos[i];
                if(this.state.selected.has(p.id)) this.state.selected.delete(p.id);
                else { if(this.state.selected.size>=this.state.MAX_SELECTION) return alert('Limit!'); this.state.selected.add(p.id); }
                this.renderGrid(); this.updateCounter();
            },
            updateCounter() { document.getElementById('selection-count').innerText = `${this.state.selected.size} wybranych`; },
            async saveSelection() { 
                try {
                    const res = await fetch(API + '/select', { 
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ token: this.state.currentAlbumToken, photoIds: Array.from(this.state.selected) })
                    });
                    if(res.ok) alert('Wyb√≥r zapisany! Fotograf zosta≈Ç powiadomiony.');
                } catch(e) { alert('B≈ÇƒÖd zapisu'); }
            },
            setFilter(t) { 
                this.state.viewFilter = t;
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('filter-' + t).classList.add('active');
                
                const cards = document.querySelectorAll('.photo-card');
                cards.forEach(c => {
                    if(t === 'all') c.style.display = 'block';
                    else {
                        if(c.classList.contains('selected')) c.style.display = 'block';
                        else c.style.display = 'none';
                    }
                });
            }, 
            openLightbox(i) { 
                this.state.currentPhotoIndex = i;
                const lightbox = document.getElementById('lightbox');
                const img = document.getElementById('lightbox-img');
                const p = this.state.photos[i];
                img.src = p.proof_url;
                lightbox.classList.add('active');
                this.updateLightboxBtn();
            }, 
            closeLightbox() { document.getElementById('lightbox').classList.remove('active'); }, 
            nextPhoto() { 
                if(this.state.currentPhotoIndex < this.state.photos.length - 1) {
                    this.openLightbox(this.state.currentPhotoIndex + 1);
                }
            }, 
            prevPhoto() { 
                if(this.state.currentPhotoIndex > 0) {
                    this.openLightbox(this.state.currentPhotoIndex - 1);
                }
            }, 
            toggleSelectionFromLightbox() { 
                this.toggleSelection(this.state.currentPhotoIndex);
                this.updateLightboxBtn();
            },
            updateLightboxBtn() {
                const btn = document.getElementById('lb-select-btn');
                const p = this.state.photos[this.state.currentPhotoIndex];
                if(this.state.selected.has(p.id)) {
                    btn.classList.add('active');
                    btn.innerText = "Wybrano ‚ù§";
                } else {
                    btn.classList.remove('active');
                    btn.innerText = "Wybierz zdjƒôcie";
                }
            }
        };
        app.init();
    </script>
</body>
</html>
