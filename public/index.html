<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julia Berlik Foto | Strefa Klienta</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    
    <div id="toast-container">
        <div id="toast-text">Komunikat</div>
    </div>

    <div id="lightbox">
        <div id="lb-close" class="lb-close">&times;</div>
        <div id="lb-prev" class="lb-nav lb-prev">&#10094;</div>
        <div id="lb-next" class="lb-nav lb-next">&#10095;</div>
        <img id="lightbox-img" src="" alt="Podgląd">
        <div class="lb-controls">
            <button id="lb-select-btn" class="lb-select-btn">Wybierz zdjęcie</button>
        </div>
    </div>

    <div class="brand-title">
        Julia Berlik <span>Foto</span>
    </div>

    <div id="view-login" class="container hidden">
        <div class="card">
            <h2>Panel Fotografa</h2>
            <p style="color:#888; margin-bottom:20px;">Zaloguj się, aby zarządzać sesjami</p>
            <form id="login-form">
                <input type="email" id="email" placeholder="Email" required value="admin@example.com" autocomplete="username">
                <input type="password" id="password" placeholder="Hasło" required value="admin123" autocomplete="current-password">
                <button type="submit" style="width:100%">Wejdź</button>
            </form>
        </div>
    </div>

    <div id="view-dashboard" class="container hidden fade-in">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h3>Zarządzanie Sesjami</h3>
            <div>
                <button id="btn-new-session">+ Nowa Sesja</button>
                <button id="btn-logout" style="background:#eee; color:#333; margin-left:10px;">Wyloguj</button>
            </div>
        </header>
        <div id="albums-list"></div>
    </div>

    <div id="view-upload" class="container hidden fade-in">
        <button id="btn-upload-back" style="background:transparent; color:#333; border:1px solid #ddd; margin-bottom:20px;">← Wróć</button>
        <div class="card" style="max-width:800px;">
            <h2>Utwórz Sesję</h2>
            <form id="upload-form">
                <label for="albumTitle">Nazwa Sesji</label>
                <input type="text" id="albumTitle" placeholder="np. Ślub Ani" required>
                
                <label for="clientName">Klient</label>
                <input type="text" id="clientName" placeholder="Imię i Nazwisko" required>
                
                <label for="clientEmailUpload">Email (Opcjonalnie)</label>
                <input type="email" id="clientEmailUpload" placeholder="Jeśli podasz, wyślemy link">
                
                <div style="border:2px dashed #ddd; padding:30px; margin:20px 0;">
                    <label for="files" style="display:block; margin-bottom:10px;">Wybierz pliki JPG (System automatycznie podzieli upload)</label>
                    <input type="file" id="files" multiple accept="image/jpeg" required>
                </div>
                <button type="submit" id="uploadBtn" style="width:100%">Rozpocznij Upload</button>
            </form>
            <div id="upload-status" style="margin-top:20px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="view-gallery" class="hidden">
        <div class="container">
            <div class="gallery-container fade-in">
                <header class="gallery-header">
                    <div>
                        <h2 id="gallery-title" style="font-size:1.5rem; margin:0;">Tytuł</h2>
                        <p style="font-size:0.9rem; color:#888;">Kliknij serce na zdjęciu, aby je wybrać.</p>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:flex-end;">
                        <span id="selection-count" style="font-weight:bold; color:var(--accent); font-size:1.2rem;">0 wybranych</span>
                        <button id="saveBtn">Zatwierdź Wybór</button>
                    </div>
                </header>

                <div class="filters">
                    <button id="filter-all" class="filter-btn active" data-filter="all">Wszystkie</button>
                    <button id="filter-selected" class="filter-btn" data-filter="selected">Tylko Wybrane ❤</button>
                </div>
                
                <div id="grid" class="gallery-grid"></div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';

        const router = {
            views: ['login', 'dashboard', 'upload', 'gallery'],
            go(viewId) {
                this.views.forEach(v => {
                    const el = document.getElementById('view-' + v);
                    if(el) el.classList.add('hidden');
                });
                const active = document.getElementById('view-' + viewId);
                if(active) active.classList.remove('hidden');
                if(viewId === 'gallery') document.querySelector('.brand-title').style.display = 'block';
            }
        };

        const app = {
            // POPRAWKA UX: Dodano MAX_SELECTION
            state: { selected: new Set(), currentAlbumToken: null, photos: [], currentPhotoIndex: 0, viewFilter: 'all', MAX_SELECTION: 50 },

            async init() {
                // PRZENIESIONA OBSŁUGA ZDARZEŃ (Eliminacja błędów CSP)
                this.setupEventListeners();

                // ROUTING
                const path = window.location.pathname;
                if (path.startsWith('/gallery/')) {
                    const token = path.split('/')[2];
                    if(token) this.loadGallery(token);
                } else {
                    try {
                        const res = await fetch(API + '/auth/check', { credentials: 'include' }); 
                        if(res.ok) this.loadDashboard();
                        else router.go('login');
                    } catch(e) { router.go('login'); }
                }
            },

            setupEventListeners() {
                // Obsługa formularzy
                document.getElementById('login-form')?.addEventListener('submit', (e) => { e.preventDefault(); this.login(); });
                document.getElementById('upload-form')?.addEventListener('submit', (e) => { e.preventDefault(); this.createAlbum(); });

                // Obsługa przycisków Dashboard
                document.getElementById('btn-new-session')?.addEventListener('click', () => router.go('upload'));
                document.getElementById('btn-logout')?.addEventListener('click', () => this.logout());
                document.getElementById('btn-upload-back')?.addEventListener('click', () => router.go('dashboard'));
                
                // Obsługa przycisków Galerii i Filtrowania
                document.getElementById('saveBtn')?.addEventListener('click', () => this.saveSelection());
                document.getElementById('filter-all')?.addEventListener('click', (e) => this.setFilter(e.target.dataset.filter));
                document.getElementById('filter-selected')?.addEventListener('click', (e) => this.setFilter(e.target.dataset.filter));
                
                // Obsługa Lightbox
                document.getElementById('lb-close')?.addEventListener('click', () => this.closeLightbox());
                document.getElementById('lb-prev')?.addEventListener('click', () => this.prevPhoto());
                document.getElementById('lb-next')?.addEventListener('click', () => this.nextPhoto());
                document.getElementById('lb-select-btn')?.addEventListener('click', () => this.toggleSelectionFromLightbox());
                
                // Obsługa kliknięć na siatce zdjęć (delegacja)
                document.getElementById('grid')?.addEventListener('click', (e) => {
                    const card = e.target.closest('.photo-card');
                    if (card) {
                        const originalIndex = card.dataset.index;
                        if (e.target.closest('.heart-icon')) {
                            this.toggleSelection(parseInt(originalIndex));
                        } else {
                            this.openLightbox(parseInt(originalIndex));
                        }
                    }
                });

                // Obsługa klawiszy Lightboxa
                document.addEventListener('keydown', (e) => {
                    if (!document.getElementById('lightbox').classList.contains('active')) return;
                    if (e.key === 'ArrowLeft') this.prevPhoto();
                    if (e.key === 'ArrowRight') this.nextPhoto();
                    if (e.key === 'Escape') this.closeLightbox();
                    if (e.key === ' ') { e.preventDefault(); this.toggleSelectionFromLightbox(); }
                });
                
                // Blokada prawego przycisku myszy (choć CSP tego nie wymaga, UX jest zachowany)
                document.body.addEventListener('contextmenu', (e) => e.preventDefault());
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast-container');
                const text = document.getElementById('toast-text');
                text.innerText = message;
                toast.classList.add('active');
                setTimeout(() => { toast.classList.remove('active'); }, 3500);
            },

            async login() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    const res = await fetch(API + '/auth/login', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ email, password }),
                        credentials: 'include'
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    this.loadDashboard();
                } catch (err) { alert(err.message); }
            },

            async logout() { 
                await fetch(API + '/auth/logout', { method: 'POST', credentials: 'include' });
                router.go('login'); 
            },

            async loadDashboard() {
                router.go('dashboard');
                try {
                    const res = await fetch(API + '/admin/albums', { credentials: 'include' });
                    const albums = await res.json();
                    const container = document.getElementById('albums-list');
                    
                    if(albums.length === 0) {
                        container.innerHTML = '<p style="text-align:center; color:#888;">Brak albumów.</p>';
                        return;
                    }

                    container.innerHTML = albums.map(a => `
                        <div style="background:white; padding:20px; margin-bottom:15px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                            <div>
                                <h3 style="margin-bottom:5px;">${a.title}</h3>
                                <p style="color:#666; font-size:0.9rem;">${a.client_name} • ${a.photo_count || 0} zdjęć • Wybrano: <strong>${a.selection_count || 0}</strong></p>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button data-album-id="${a.id}" class="btn-copy btn-copy-filenames" style="font-size:11px;">Kopiuj listę</button>
                                <a href="/gallery/${a.access_token}" target="_blank"><button style="font-size:11px;">Podgląd</button></a>
                                <button data-album-id="${a.id}" class="btn-danger btn-delete-album" style="font-size:11px;">Usuń</button>
                            </div>
                        </div>
                    `).join('');

                    // Dynamiczne event listeners dla listy albumów
                    document.querySelectorAll('.btn-copy-filenames').forEach(btn => {
                        btn.addEventListener('click', () => this.copyFilenames(btn.dataset.albumId));
                    });
                    document.querySelectorAll('.btn-delete-album').forEach(btn => {
                        btn.addEventListener('click', () => this.deleteAlbum(btn.dataset.albumId));
                    });

                } catch (err) { console.error(err); }
            },

            async copyFilenames(albumId) {
                try {
                    const res = await fetch(API + '/admin/albums/' + albumId + '/files', { credentials: 'include' });
                    const data = await res.json();
                    if(data.filenames?.length > 0) {
                        navigator.clipboard.writeText(data.filenames.join(', '));
                        this.showToast('Skopiowano listę plików!', 'success');
                    } else {
                        this.showToast('Brak wybranych zdjęć.', 'error');
                    }
                } catch (err) { this.showToast('Błąd kopiowania.', 'error'); }
            },

            async deleteAlbum(id) {
                if(!confirm('Czy na pewno chcesz usunąć ten album?')) return;
                try {
                    const res = await fetch(API + '/albums/' + id, { method: 'DELETE', credentials: 'include' });
                    if(res.ok) { this.showToast('Album usunięty.', 'success'); this.loadDashboard(); }
                    else { throw new Error('Błąd usuwania'); }
                } catch (err) { this.showToast('Błąd: ' + err.message, 'error'); }
            },

            async createAlbum() {
                const btn = document.getElementById('uploadBtn');
                const statusDiv = document.getElementById('upload-status');
                const title = document.getElementById('albumTitle').value;
                const clientName = document.getElementById('clientName').value;
                const clientEmail = document.getElementById('clientEmailUpload').value;
                const filesInput = document.getElementById('files');
                const files = Array.from(filesInput.files);

                if(files.length === 0) return this.showToast('Wybierz zdjęcia', 'error');

                btn.disabled = true; btn.innerText = "Przetwarzanie...";
                
                try {
                    // 1. Tworzenie Albumu
                    const res1 = await fetch(API + '/albums', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ title, clientName }),
                        credentials: 'include'
                    });
                    
                    if(!res1.ok) throw new Error('Błąd tworzenia albumu');
                    const albumData = await res1.json();
                    const albumId = albumData.id;
                    const accessToken = albumData.access_token;

                    // 2. Batch Upload
                    const BATCH_SIZE = 3;
                    let uploaded = 0;

                    for (let i = 0; i < files.length; i += BATCH_SIZE) {
                        const chunk = files.slice(i, i + BATCH_SIZE);
                        const formData = new FormData();
                        formData.append('albumId', albumId);
                        chunk.forEach(f => formData.append('photos', f));

                        // Pasek postępu
                        const progress = Math.round((uploaded / files.length) * 100);
                        statusDiv.innerHTML = `
                            <div style="margin-top:10px;">
                                Wysyłanie: ${uploaded}/${files.length} (${progress}%)
                                <div style="width:100%; height:10px; background:#eee; margin-top:5px;">
                                    <div style="width:${progress}%; height:100%; background:var(--accent); transition:width 0.3s;"></div>
                                </div>
                            </div>`;

                        const resUpload = await fetch(API + '/upload', { 
                            method: 'POST', 
                            body: formData,
                            credentials: 'include'
                        });

                        if(!resUpload.ok) throw new Error('Błąd wysyłania partii zdjęć');
                        uploaded += chunk.length;
                    }

                    // 3. Koniec
                    statusDiv.innerHTML = "Wysyłanie zakończone sukcesem!";
                    
                    if (clientEmail) {
                        statusDiv.innerText += " Wysyłanie maila...";
                        const link = window.location.origin + '/gallery/' + accessToken;
                        await fetch(API + '/send-link', { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ clientEmail, albumTitle: title, link }),
                            credentials: 'include'
                        });
                        this.showToast('Wysłano do klienta!', 'success');
                    } else { 
                        this.showToast('Gotowe!', 'success'); 
                    }
                    setTimeout(() => this.loadDashboard(), 1000);

                } catch (err) { 
                    statusDiv.innerText = "Błąd: " + err.message;
                    this.showToast('Błąd uploadu', 'error'); 
                } finally { 
                    btn.disabled = false; btn.innerText = "Rozpocznij Upload"; 
                }
            },

            async loadGallery(token) {
                this.state.currentAlbumToken = token;
                router.go('gallery');
                const grid = document.getElementById('grid');
                grid.innerHTML = Array(8).fill('<div class="photo-card skeleton"></div>').join('');

                try {
                    const res = await fetch(API + '/gallery/' + token); 
                    if(!res.ok) throw new Error('Błąd');
                    const data = await res.json();
                    
                    document.getElementById('gallery-title').innerText = data.album[0].title;
                    this.state.selected = new Set(data.selections);
                    this.state.photos = data.photos;
                    this.renderGrid();
                    this.updateCounter();

                    if(!localStorage.getItem('visited_' + token)) {
                        this.showToast('Witaj! Wybierz zdjęcia klikając serce.', 'success');
                        localStorage.setItem('visited_' + token, 'true');
                    }
                } catch (err) { 
                    document.getElementById('view-gallery').innerHTML = "<div class='container' style='text-align:center; padding:100px;'><h1>404</h1><p>Nie znaleziono galerii.</p></div>"; 
                }
            },

            setFilter(type) {
                this.state.viewFilter = type;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.filter-btn[data-filter="${type}"]`).classList.add('active');
                this.renderGrid();
            },

            renderGrid() {
                const grid = document.getElementById('grid');
                let photosToShow = this.state.photos;

                if (this.state.viewFilter === 'selected') {
                    photosToShow = this.state.photos.filter(p => this.state.selected.has(p.id));
                }

                if (photosToShow.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; padding:40px; color:#888;">Brak zdjęć do wyświetlenia.</p>';
                    return;
                }

                // Dodano data-index i usunięto inline onclick/stopPropagation
                grid.innerHTML = photosToShow.map((p) => {
                    const originalIndex = this.state.photos.findIndex(photo => photo.id === p.id);
                    const isSelected = this.state.selected.has(p.id) ? 'selected' : '';
                    
                    return `
                    <div class="photo-card ${isSelected}" data-index="${originalIndex}">
                        <div class="heart-icon">
                            ${isSelected ? '❤' : '♡'}
                        </div>
                        <img src="${p.proof_url}" loading="lazy" alt="Zdjęcie" onerror="this.src='placeholder.jpg'">
                    </div>`;
                }).join('');
            },

            toggleSelection(index) {
                const p = this.state.photos[index];
                if (this.state.selected.has(p.id)) this.state.selected.delete(p.id);
                else {
                    // POPRAWKA UX: Sprawdzenie limitu wybranych zdjęć
                    if(this.state.selected.size >= this.state.MAX_SELECTION) {
                        this.showToast(`Możesz wybrać maksymalnie ${this.state.MAX_SELECTION} zdjęć.`, 'error');
                        return;
                    }
                    
                    this.state.selected.add(p.id);
                    if(navigator.vibrate) navigator.vibrate(50);
                }
                this.renderGrid(); 
                this.updateCounter();
            },

            openLightbox(index) {
                this.state.currentPhotoIndex = index;
                const p = this.state.photos[index];
                document.getElementById('lightbox-img').src = p.proof_url;
                document.getElementById('lightbox').classList.add('active');
                this.updateLightboxUI();
            },
            closeLightbox() { document.getElementById('lightbox').classList.remove('active'); },
            
            nextPhoto() { if (this.state.currentPhotoIndex < this.state.photos.length - 1) this.openLightbox(this.state.currentPhotoIndex + 1); },
            prevPhoto() { if (this.state.currentPhotoIndex > 0) this.openLightbox(this.state.currentPhotoIndex - 1); },

            toggleSelectionFromLightbox() {
                const p = this.state.photos[this.state.currentPhotoIndex];
                if (this.state.selected.has(p.id)) this.state.selected.delete(p.id);
                else {
                    // POPRAWKA UX: Sprawdzenie limitu wybranych zdjęć w lightboxie
                    if(this.state.selected.size >= this.state.MAX_SELECTION) {
                        this.showToast(`Możesz wybrać maksymalnie ${this.state.MAX_SELECTION} zdjęć.`, 'error');
                        return;
                    }
                    this.state.selected.add(p.id);
                }
                this.updateLightboxUI();
                this.renderGrid();
                this.updateCounter();
            },

            updateLightboxUI() {
                const p = this.state.photos[this.state.currentPhotoIndex];
                const btn = document.getElementById('lb-select-btn');
                if (this.state.selected.has(p.id)) {
                    btn.classList.add('active');
                    btn.innerText = "❤ WYBRANE";
                } else {
                    btn.classList.remove('active');
                    btn.innerText = "Wybierz zdjęcie";
                }
            },

            updateCounter() { document.getElementById('selection-count').innerText = `${this.state.selected.size} wybranych`; },

            async saveSelection() {
                const btn = document.getElementById('saveBtn');
                btn.innerText = "Wysyłanie..."; btn.disabled = true;
                const token = this.state.currentAlbumToken;
                try {
                    await fetch(API + '/select', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ token: token, photoIds: Array.from(this.state.selected) }) 
                    });
                    this.showToast('Wybór zapisany i wysłany!', 'success');
                } catch (err) { this.showToast('Błąd zapisu.', 'error'); } 
                finally { btn.innerText = "Zatwierdź Wybór"; btn.disabled = false; }
            }
        };

        app.init();
    </script>
</body>
</html>
